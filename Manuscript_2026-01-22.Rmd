---
title: "Manuscript_V8"
author: "ClaytonRushford"
date: "`r Sys.Date()`"
output: html_document
---

```{r}

```

Load libraries
```{r}
#| echo: false
#| message: false
#| warning: false


library(stringr)
library(gridExtra)
library(dplyr)
library(readr)
library(caret)
library(tidyverse)
library(cowplot)
library(patchwork)
library(paletteer)
library(lubridate)
library(vegan)
library(ape)
library(ggplot2)
library(dplyr)
library(viridis)
set.seed(12)
theme_set(theme_cowplot())


```

Load in weather data
```{r}
#read in metadata xlsx
metadata <- read.csv("WeatherData.csv")


```



```{r}

# Helper to tidy a ribodepleted TSV (works for 2024 & 2025 formats)
tidy_ribo <- function(path) {
  read_tsv(path, show_col_types = FALSE) %>%
    # keep only R1 files
    filter(!str_detect(Filename, "r2")) %>%
    mutate(
      read_class = if_else(str_detect(Filename, "no_rrna"), "non_rrna", "rrna"),
      SampleID   = str_remove(Filename, "_r1_(no_)?rrna\\.fastq\\.gz$")
    ) %>%
    select(-Filename) %>%
    # Put rrna_/non_rrna_ in front of each numeric column via .value trick
    pivot_wider(
      id_cols    = SampleID,
      names_from = read_class,
      values_from = -c(SampleID, read_class),
      names_glue = "{read_class}_{.value}"
    )
}

# --- Load ribodepleted counts for both years ---
ribo_2024 <- tidy_ribo("RibodepletedReadCounts.tsv")
ribo_2025 <- tidy_ribo("RibodepletedReadCount2025.tsv")

ribodepletedcounts <- bind_rows(ribo_2024, ribo_2025) %>% distinct(SampleID, .keep_all = TRUE)

# --- Merge with metadata (SampleDate remains character) ---
# Expect metadata to have SampleID (chr) and SampleDate (chr)
Fig1a <- ribodepletedcounts %>%
  inner_join(metadata, by = "SampleID")

# --- Build an ordering date WITHOUT replacing SampleDate (just for sort/labels) ---
# Try m/d/Y first (your WeatherData.csv style); fall back to Y-m-d if needed
Fig1a <- Fig1a %>%
  mutate(
    date_ord = suppressWarnings(lubridate::mdy(SampleDate)),
    date_ord = if_else(is.na(date_ord), suppressWarnings(lubridate::ymd(SampleDate)), date_ord)
  )


# --- Label text: mm-dd; add special marks for 2024 ONLY ---
mmdd <- format(Fig1a$date_ord, "%m-%d")


Fig1a <- Fig1a %>%
  mutate(
    SampleLabel = format(date_ord, "%Y-%m-%d")
  )

# Define ticks and labels for each month (first sample per month)
monthly_ticks <- Fig1a %>%
  group_by(month = format(date_ord, "%Y-%m")) %>%
  summarise(x_tick = first(SampleLabel), .groups = "drop") %>%
  pull(x_tick)

monthly_labels <- Fig1a %>%
  group_by(month = format(date_ord, "%Y-%m")) %>%
  summarise(label = format(first(date_ord), "%b %Y"), .groups = "drop") %>%
  pull(label)



# --- Order labels chronologically using date_ord, but display SampleLabel ---
Fig1a <- Fig1a %>%
  arrange(date_ord) %>%
  mutate(SampleLabel = factor(SampleLabel, levels = unique(SampleLabel)))

# --- Long format for plotting (rRNA vs non-rRNA) ---
Fig1a_long <- Fig1a %>%
  select(SampleID, SampleDate, date_ord, SampleLabel,
         rrna_Main_genome_contig_total, non_rrna_Main_genome_contig_total) %>%
  pivot_longer(
    cols = c(rrna_Main_genome_contig_total, non_rrna_Main_genome_contig_total),
    names_to = "ReadType",
    values_to = "ReadCounts"
  ) %>%
  mutate(
    ReadType = recode(ReadType,
                      rrna_Main_genome_contig_total     = "rRNA reads",
                      non_rrna_Main_genome_contig_total = "non-rRNA reads")
  ) %>%
  # ensure stacked order: rRNA on bottom
  mutate(ReadType = factor(ReadType, levels = c("non-rRNA reads", "rRNA reads"))) %>%
  arrange(date_ord, ReadType) %>%
  group_by(SampleLabel) %>%
  mutate(TotalReads = sum(ReadCounts, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(RelativeAbundance = ReadCounts / TotalReads)

# --- Dynamic y-axis breaks for raw counts (0.5B steps up to top) ---
max_y <- max(Fig1a_long$ReadCounts, na.rm = TRUE)
top_y <- ceiling(max_y / 5e8) * 5e8
breaks_vec <- seq(5e8, top_y, by = 5e8)

# --- Plots (same styling as yours) ---
raw_counts_plot <- ggplot(Fig1a_long, aes(x = SampleLabel, y = ReadCounts)) +
  geom_bar(stat = "identity", fill = "darkblue", size = 0.5, width = 0.8) +
  labs(x = NULL, y = "Read counts") +
  scale_y_continuous(breaks = breaks_vec, labels = scales::scientific, expand = c(0, 0)) +
  theme_cowplot() +
  theme(
    axis.line   = element_line(color = "black"),
    axis.text.x = element_blank(),
    axis.ticks.x= element_blank(),
    axis.text.y = element_text(size = 11),
    axis.title.y= element_text(size = 11),
    plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
  )

relative_abundance_plot <- ggplot(Fig1a_long, aes(x = SampleLabel, y = RelativeAbundance, fill = ReadType)) +
  geom_bar(stat = "identity", size = 0.5, width = 0.8) +
  labs(x = "Sample Date", y = "rRNA abundance") +
  scale_y_continuous(labels = scales::percent, expand = c(0, 0)) +
  scale_fill_manual(values = c("rRNA reads" = "black", "non-rRNA reads" = "grey")) +
  scale_x_discrete(
  expand = c(0, 0),
  breaks = monthly_ticks,
  labels = monthly_labels
)+
  theme_cowplot() +
  theme(
    axis.line   = element_line(color = "black"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.x= element_text(size = 11),
    axis.title.y= element_text(size = 11),
    legend.position = "none",
    plot.margin = margin(t = 0, r = 5, b = 5, l = 5)
  )

combined_plot <- plot_grid(raw_counts_plot, relative_abundance_plot, ncol = 1, align = "v", rel_heights = c(1,1))

# Save figure and export the long table (keeps SampleDate as character)
#ggsave("./ManuscriptFigures/fig1a_combined.png",
#       plot = combined_plot,
#       width = 7,
#       height = 4,
#       dpi = 300)

#ggsave("./ManuscriptFigures/fig1a_combined.tiff",
#       plot = combined_plot,
#       width = 7,
#       height = 4,
#       dpi = 600,
#       compression = "lzw")

#write_tsv(Fig1a_long %>% select(-date_ord), "Fig1adata_long.tsv")

# Average rRNA relative abundance
average_rRNA <- Fig1a_long %>%
  filter(ReadType == "rRNA reads") %>%
  summarise(average = mean(RelativeAbundance, na.rm = TRUE))
average_rRNA
```


```{r}
library(cowplot)
library(ggplot2)
library(grid)

# =========================
# Step 1: make sure combined_plot CAN have a legend, extract it, print it
# =========================
relative_with_legend <- relative_abundance_plot +
  labs(fill = "Read Type") +
  guides(
    fill = guide_legend(
      direction = "vertical",
      ncol = 1
    )
  ) +
  theme(
    legend.position = "bottom",
    legend.text  = element_text(size = 10),
    legend.key.size = grid::unit(0.4, "cm"),

    # ✅ This is the one that actually tightens title → keys gap
    legend.title = element_text(size = 10, margin = margin(b = 0)),

    # Optional: tighten vertical spacing between legend rows (often subtle)
    legend.key.height = grid::unit(0.4, "cm")
  )

print(relative_with_legend)



# Sanity check: you MUST see a legend here, or there is nothing to extract
print(relative_with_legend)

# Build a combined version *with* legend (not strictly required, but matches your Step 1 wording)
combined_plot_with_legend <- plot_grid(
  raw_counts_plot,
  relative_with_legend,
  ncol = 1,
  align = "v",
  rel_heights = c(1, 1)
)

# --- Robust legend extraction (does not depend on cowplot::get_legend) ---
g <- ggplotGrob(relative_with_legend)

guide_idx <- which(sapply(g$grobs, function(x) x$name) == "guide-box")

if (length(guide_idx) == 0) {
  stop("No legend found (no 'guide-box' in the grob). The plot you printed above truly has no legend.")
}

legend_g <- g$grobs[[guide_idx[1]]]

# Print the extracted legend alone so you can confirm it extracted
print(ggdraw() + draw_grob(legend_g))

# =========================
# Step 2–4: bigger blank canvas; paste plot near top; paste legend near bottom
# =========================

# Your original combined_plot should remain legendless (use it directly)
combined_plot_nolegend <- combined_plot

# A blank canvas (we'll save with larger height to create space below)
final_plot <- ggdraw() +
  # Step 3: paste combined plot near the top
  draw_plot(combined_plot_nolegend,
            x = 0.00, y = 0.22, width = 1.00, height = 0.78) +
  # Step 4: paste legend near the bottom (right-ish like your screenshot)
  draw_grob(legend_g,
            x = 0.8, y = 0.1, width = 0.45, height = 0.18)

print(final_plot)

ggsave(
  "./ManuscriptFigures/Figure1.tiff",
  plot = final_plot,
  width = 7,
  height = 4.8,     # bigger than original so legend sits below x-axis text
  dpi = 600,
  device = "tiff",
  compression = "lzw"
)


```


```{r}
# --- Correlate rRNA abundance with water quality (2024–2025, no suppression) ---

library(dplyr)
library(lubridate)
library(readxl)

# 1) Load metadata from Excel (edit filename if needed)
meta_raw <- read_excel("Columbia meta data 9.3.25.xlsx", sheet = 1)

# 2) Select and rename only the columns you care about
meta_clean <- meta_raw %>%
  transmute(
    SampleEndDate = as.Date(`Sample end date`),
    Flow_MGD      = as.numeric(`Average influent flow over sampling period (MGD):`),
    pH            = as.numeric(`pH value`),
    Temp_C        = as.numeric(`Water temperature value`),
    COD_mgL       = as.numeric(`COD value`),
    TSS_mgL       = as.numeric(`TSS value`),
    Year          = year(SampleEndDate),
    SampleKey     = format(SampleEndDate, "%m-%d")
  ) %>%
  filter(!is.na(SampleEndDate))

# 3) Prepare Fig1a_long for joining
fig1_rRNA <- Fig1a_long %>%
  filter(ReadType == "rRNA reads") %>%
  mutate(
    Year = year(date_ord),
    SampleKey = format(date_ord, "%m-%d")
  ) %>%
  select(Year, SampleKey, RelativeAbundance, SampleDate)

# 4) Join rRNA abundance with water quality metadata
merged_data <- fig1_rRNA %>%
  inner_join(meta_clean, by = c("Year", "SampleKey"))

# 5) Diagnostic info
message("Matched rows: ", nrow(merged_data),
        " | Unique dates matched: ", n_distinct(merged_data$SampleDate))
message("Non-NA counts — Flow: ", sum(!is.na(merged_data$Flow_MGD)),
        ", pH: ", sum(!is.na(merged_data$pH)),
        ", Temp_C: ", sum(!is.na(merged_data$Temp_C)),
        ", COD: ", sum(!is.na(merged_data$COD_mgL)),
        ", TSS: ", sum(!is.na(merged_data$TSS_mgL)))

# 6) Correlation matrix (Spearman)
vars_to_correlate <- c("RelativeAbundance", "Flow_MGD", "pH", "Temp_C", "COD_mgL", "TSS_mgL")

cor_matrix <- cor(
  merged_data[, vars_to_correlate],
  use = "pairwise.complete.obs",
  method = "spearman"
)

cat("\n=== Spearman Correlation (rRNA abundance vs water quality, 2024–2025) ===\n")
print(round(cor_matrix, 3))

```




Load in raw NVD tsv
```{r}
# ETL: read new TSV, pre-filter to Columbia, MO, prep for SQL
library(DBI)
library(RSQLite)
library(readr)
library(dplyr)
library(stringr)

# Use the new 2025 ETL file (explicit)
etl_path <- "metagenomic_hits_top_hit_etl_example_31108_31648.tsv"
stopifnot(file.exists(etl_path))

# Read TSV
etl_raw <- read_tsv(etl_path, col_types = cols())

# Rename to stable snake_case-ish names expected by SQL and
# ***filter to Columbia, MO before doing anything else***
etl_data <- etl_raw %>%
  dplyr::rename(
    sewershed_location = `Sewershed Location`,
    sample_date        = `Sample Date`,
    stitle             = `Stitle`,
    rank               = `Rank`,
    species            = `Species`,
    mapped_reads       = `Mapped Reads`,
    total_reads        = `Total Reads`
  ) %>%
  filter(sewershed_location == "Columbia, MO",
    Experiment %in% c(31108, 31648)) %>%         
  mutate(
    sample_date  = as.character(sample_date),       
    mapped_reads = as.numeric(mapped_reads),
    total_reads  = as.numeric(total_reads)
  )

# Create a temporary in-memory SQLite database
con <- dbConnect(RSQLite::SQLite(), ":memory:")

# Copy the (already filtered) data frame into the database
dbWriteTable(con, "metagenomic_hits_top_hit_etl", etl_data, overwrite = TRUE)

# Optional spot-checks
spotcheck <- etl_data %>% filter(str_detect(rank, regex("Influenza", ignore_case = TRUE)))
unique(etl_data$sample_date)



```
```{r}

parecho_only <- etl_data %>%
  filter(str_detect(rank, regex("Filo", ignore_case = TRUE)))
```


Extract virus groups with SQL
```{sql connection=con, output.var=NVDSQLoutput}

-- SQL: build virus groupings; data already filtered to Columbia, MO in R,
-- but we enforce it here too for belt-and-suspenders consistency.

WITH base AS (
    SELECT
        sewershed_location,
        sample_date,
        sample_date AS time_label,
        rank,
        species,
        stitle,
        mapped_reads,
        total_reads
    FROM metagenomic_hits_top_hit_etl
    WHERE sewershed_location = 'Columbia, MO'   -- safety: enforce location here too
      AND sample_date IS NOT NULL
),

mapped_viruses AS (
    SELECT
        sewershed_location,
        time_label,
        mapped_reads,
        total_reads,
        CASE
            WHEN LOWER(rank) LIKE '%norovirus gii;%'                                   THEN 'Norovirus genogroup II'
            WHEN LOWER(rank) LIKE '%norovirus gi;%'                                    THEN 'Norovirus genogroup I'
            WHEN LOWER(rank) LIKE '%norovirus giv;%'                                   THEN 'Norovirus genogroup IV'
            WHEN LOWER(rank) LIKE '%rotavirus a%'  AND LOWER(stitle) LIKE '%human%'    THEN 'Rotavirus A'
            WHEN LOWER(rank) LIKE '%rotavirus b%'  AND LOWER(stitle) LIKE '%human%'    THEN 'Rotavirus B'
            WHEN LOWER(rank) LIKE '%rotavirus c%'  AND LOWER(stitle) LIKE '%human%'    THEN 'Rotavirus C'
            WHEN LOWER(rank) LIKE '%astrovirus mlb%'                                   THEN 'Astrovirus MLB'
            WHEN LOWER(rank) LIKE '%astrovirus va%'                                    THEN 'Astrovirus VA'
            WHEN LOWER(rank) LIKE '%astrovirus%' AND
                 LOWER(rank) NOT LIKE '%astrovirus mlb%' AND
                 LOWER(rank) NOT LIKE '%astrovirus va%'                                THEN 'Human astrovirus (Other)'
            WHEN LOWER(rank) LIKE '%sapporo virus%' AND LOWER(stitle) LIKE '%hu/%'     THEN 'Sapporo virus'
            WHEN LOWER(rank) LIKE '%kobuvirus%'  AND LOWER(stitle) LIKE '%hu/%'        THEN 'Aichivirus'
            WHEN LOWER(rank) LIKE '%human adenovirus 40%'                              THEN 'Human adenovirus F40'
            WHEN LOWER(rank) LIKE '%human adenovirus 41%'                              THEN 'Human adenovirus F41'
            WHEN LOWER(rank) LIKE '%human mastadenovirus a%'                           THEN 'Human mastadenovirus A'
            WHEN LOWER(rank) LIKE '%human mastadenovirus b%'                           THEN 'Human mastadenovirus B'
            WHEN LOWER(rank) LIKE '%human mastadenovirus c%'                           THEN 'Human mastadenovirus C'
            WHEN LOWER(rank) LIKE '%human mastadenovirus d%'                           THEN 'Human mastadenovirus D'
            WHEN LOWER(rank) LIKE '%human picobirnavirus%'                             THEN 'Human picobirnavirus'
            WHEN LOWER(species) LIKE '%hepatovirus a%'                                 THEN 'Hepatitis A'
            WHEN LOWER(rank) LIKE '%severe acute respiratory syndrome-related coronavirus%' THEN 'SARS-CoV-2'

            WHEN LOWER(species) LIKE '%influenza a%' 
                 AND (LOWER(species) LIKE '%h1n1%' OR LOWER(stitle) LIKE '%h1n1%')     THEN 'Influenza A (H1N1)'
            WHEN LOWER(species) LIKE '%influenza a%' 
                 AND (LOWER(species) LIKE '%h3n2%' OR LOWER(stitle) LIKE '%h3n2%')     THEN 'Influenza A (H3N2)'
            WHEN LOWER(species) LIKE '%influenza a%' 
                 AND (LOWER(species) LIKE '%h5n1%' OR LOWER(stitle) LIKE '%h5n1%')     THEN 'Influenza A (H5N1)'
            WHEN LOWER(species) LIKE '%influenza a%' 
                 AND LOWER(species) NOT LIKE '%h1n1%' 
                 AND LOWER(stitle)  NOT LIKE '%h1n1%' 
                 AND LOWER(species) NOT LIKE '%h3n2%' 
                 AND LOWER(stitle)  NOT LIKE '%h3n2%' 
                 AND LOWER(species) NOT LIKE '%h5n1%' 
                 AND LOWER(stitle)  NOT LIKE '%h5n1%'                                  THEN 'Influenza A (Other)'

            WHEN LOWER(rank) LIKE '%betainfluenzavirus influenzae%'                    THEN 'Influenza B'
            WHEN LOWER(rank) LIKE '%gammainfluenzavirus influenzae%'                   THEN 'Influenza C'
            WHEN LOWER(species) LIKE '%human respiratory syncytial virus b%'           THEN 'RSV-B'
            WHEN LOWER(species) LIKE '%human respiratory syncytial virus a%'           THEN 'RSV-A'
            WHEN LOWER(species) LIKE '%human orthorubulavirus 2%'                      THEN 'Parainfluenza 2'
            WHEN LOWER(rank) LIKE '%orthorubulavirus hominis%'                         THEN 'Parainfluenza 4'
            WHEN LOWER(species) LIKE '%human respirovirus 3%'                          THEN 'Parainfluenza 3'
            WHEN LOWER(species) LIKE '%human respirovirus 1%'                          THEN 'Parainfluenza 1'
            WHEN LOWER(rank) LIKE '%bocaparvovirus%' AND LOWER(stitle) LIKE '%human%'  THEN 'Human bocavirus'

            WHEN LOWER(species) LIKE '%coronavirus 229e%'                              THEN 'Coronavirus 229E'
            WHEN LOWER(species) LIKE '%coronavirus hku1%'                              THEN 'Coronavirus HKU1'
            WHEN LOWER(species) LIKE '%coronavirus nl63%'                              THEN 'Coronavirus NL63'
            WHEN LOWER(species) LIKE '%coronavirus oc43%'                              THEN 'Coronavirus OC43'

            WHEN LOWER(species) LIKE '%enterovirus a%'  AND
                 LOWER(species) NOT LIKE '%a71%' AND LOWER(stitle) NOT LIKE '%a71%'    THEN 'Enterovirus A'
            WHEN LOWER(rank) LIKE '%enterovirus a71%'                                  THEN 'Enterovirus A71'
            WHEN LOWER(species) LIKE '%enterovirus b%'                                 THEN 'Enterovirus B'
            WHEN LOWER(species) LIKE '%enterovirus c%'                                 THEN 'Enterovirus C'
            WHEN LOWER(rank) LIKE '%enterovirus d68%'                                  THEN 'Enterovirus D68'

            WHEN LOWER(rank) LIKE '%metapneumovirus hominis%'                          THEN 'Metapneumovirus'
            WHEN LOWER(species) LIKE '%human parechovirus 3%'                          THEN 'Parechovirus 3'
            WHEN LOWER(species) LIKE '%human parechovirus 5%'                          THEN 'Parechovirus 5'
            WHEN LOWER(rank) LIKE '%parechovirus a%'                                   THEN 'Parechovirus A'

            WHEN LOWER(species) LIKE '%rhinovirus a%'                                  THEN 'Rhinovirus A'
            WHEN LOWER(species) LIKE '%rhinovirus b%'                                  THEN 'Rhinovirus B'
            WHEN LOWER(species) LIKE '%rhinovirus c%'                                  THEN 'Rhinovirus C'

            WHEN LOWER(rank) LIKE '%measles morbillivirus%'                            THEN 'Measles'
            WHEN LOWER(rank) LIKE '%mumps orthorubulavirus%'                           THEN 'Mumps'
            WHEN LOWER(rank) LIKE '%rubivirus rubellae%'                               THEN 'Rubella'
            WHEN LOWER(rank) LIKE '%monkeypox virus%'                                  THEN 'Monkeypox virus'
            WHEN LOWER(rank) LIKE '%oropouche%'                                        THEN 'Oropouche'
            WHEN LOWER(rank) LIKE '%west nile%'                                        THEN 'West Nile'

            WHEN LOWER(species) LIKE '%porcine reproductive and respiratory syndrome virus%' THEN 'PRRSV'
            WHEN LOWER(species) LIKE '%bovine viral diarrhea virus%'                   THEN 'Bovine viral diarrhea'
            WHEN LOWER(species) LIKE '%infectious bronchitis virus%'                   THEN 'Infectious bronchitis'
            ELSE NULL
        END AS virus
    FROM base
),

virus_assigned AS (
    SELECT sewershed_location, time_label, virus, mapped_reads, total_reads
    FROM mapped_viruses
    WHERE virus IS NOT NULL
),

influenza_total AS (
    SELECT
        sewershed_location,
        time_label,
        'Influenza A (Total)' AS virus,
        mapped_reads,
        total_reads
    FROM base
    WHERE LOWER(species) LIKE '%influenza a%'
),

adenovirusF_total AS (
    SELECT
        sewershed_location,
        time_label,
        'Human mastadenovirus F' AS virus,
        mapped_reads,
        total_reads
    FROM base
    WHERE LOWER(species) LIKE '%human mastadenovirus f%'
),

rhinovirus_total AS (
    SELECT
        sewershed_location,
        time_label,
        'Rhinovirus (Total)' AS virus,
        mapped_reads,
        total_reads
    FROM base
    WHERE LOWER(species) LIKE '%rhinovirus%'
),

combined AS (
    SELECT * FROM virus_assigned
    UNION ALL
    SELECT * FROM influenza_total
    UNION ALL
    SELECT * FROM rhinovirus_total
    UNION ALL
    SELECT * FROM adenovirusF_total
)

SELECT
    sewershed_location,
    time_label,
    virus,
    SUM(mapped_reads) AS mapped_reads,
    SUM(total_reads)  AS total_reads,
    CASE virus
        WHEN 'Norovirus genogroup II'      THEN 'Enteric'
        WHEN 'Norovirus genogroup I'       THEN 'Enteric'
        WHEN 'Norovirus genogroup IV'      THEN 'Enteric'
        WHEN 'Rotavirus A'                 THEN 'Enteric'
        WHEN 'Rotavirus B'                 THEN 'Enteric'
        WHEN 'Rotavirus C'                 THEN 'Enteric'
        WHEN 'Human astrovirus (Other)'    THEN 'Enteric'
        WHEN 'Astrovirus MLB'              THEN 'Enteric'
        WHEN 'Astrovirus VA'               THEN 'Enteric'
        WHEN 'Sapporo virus'               THEN 'Enteric'
        WHEN 'Aichivirus'                  THEN 'Enteric'
        WHEN 'Human adenovirus F40'        THEN 'Enteric'
        WHEN 'Human adenovirus F41'        THEN 'Enteric'
        WHEN 'Human mastadenovirus A'      THEN 'Enteric'
        WHEN 'Human mastadenovirus B'      THEN 'Enteric'
        WHEN 'Human mastadenovirus C'      THEN 'Enteric'
        WHEN 'Human mastadenovirus D'      THEN 'Enteric'
        WHEN 'Human mastadenovirus F'      THEN 'Enteric'
        WHEN 'Human picobirnavirus'        THEN 'Enteric'
        WHEN 'Hepatitis A'                 THEN 'Enteric'

        WHEN 'Enterovirus A'               THEN 'Respiratory'
        WHEN 'Enterovirus B'               THEN 'Respiratory'
        WHEN 'Enterovirus C'               THEN 'Respiratory'
        WHEN 'Enterovirus D68'             THEN 'Respiratory'
        WHEN 'SARS-CoV-2'                  THEN 'Respiratory'
        WHEN 'Influenza A (H1N1)'          THEN 'Respiratory'
        WHEN 'Influenza A (H3N2)'          THEN 'Respiratory'
        WHEN 'Influenza A (H5N1)'          THEN 'Respiratory'
        WHEN 'Influenza A (Other)'         THEN 'Respiratory'
        WHEN 'Influenza A (Total)'         THEN 'Respiratory'
        WHEN 'Influenza B'                 THEN 'Respiratory'
        WHEN 'Influenza C'                 THEN 'Respiratory'
        WHEN 'RSV-B'                       THEN 'Respiratory'
        WHEN 'RSV-A'                       THEN 'Respiratory'
        WHEN 'Parainfluenza 1'             THEN 'Respiratory'
        WHEN 'Parainfluenza 2'             THEN 'Respiratory'
        WHEN 'Parainfluenza 3'             THEN 'Respiratory'
        WHEN 'Parainfluenza 4'             THEN 'Respiratory'
        WHEN 'Human bocavirus'             THEN 'Respiratory'
        WHEN 'Coronavirus 229E'            THEN 'Respiratory'
        WHEN 'Coronavirus HKU1'            THEN 'Respiratory'
        WHEN 'Coronavirus NL63'            THEN 'Respiratory'
        WHEN 'Coronavirus OC43'            THEN 'Respiratory'
        WHEN 'Metapneumovirus'             THEN 'Respiratory'
        WHEN 'Parechovirus 3'              THEN 'Respiratory'
        WHEN 'Parechovirus 5'              THEN 'Respiratory'
        WHEN 'Parechovirus A'              THEN 'Respiratory'
        WHEN 'Rhinovirus A'                THEN 'Respiratory'
        WHEN 'Rhinovirus B'                THEN 'Respiratory'
        WHEN 'Rhinovirus C'                THEN 'Respiratory'
        WHEN 'Rhinovirus (Total)'          THEN 'Respiratory'

        WHEN 'Measles'                     THEN 'Respiratory'
        WHEN 'Mumps'                       THEN 'Respiratory'
        WHEN 'Rubella'                     THEN 'Respiratory'
        WHEN 'Monkeypox virus'             THEN 'atypical'
        WHEN 'Oropouche'                   THEN 'atypical'
        WHEN 'West Nile'                   THEN 'atypical'

        WHEN 'PRRSV'                       THEN 'veterinary'
        WHEN 'Bovine viral diarrhea'       THEN 'veterinary'
        WHEN 'Infectious bronchitis'       THEN 'veterinary'
        ELSE NULL
    END AS virus_type
FROM combined
GROUP BY sewershed_location, time_label, virus
ORDER BY sewershed_location, time_label, virus;




```

```{r}

parecho_only <- NVDSQLoutput %>%
  filter(str_detect(virus, regex("Parechovirus", ignore_case = TRUE)))
```

Make NVD heatmaps
```{r}
# Use SQL output; keep time_label as character, derive helpers for ordering/labels
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)

# 1) Clean + normalize (no hardcoded years)
labkey.data <- NVDSQLoutput %>%
  mutate(
    time_label   = as.character(time_label),                 # keep character
    date_ord     = suppressWarnings(lubridate::ymd(time_label)),  # helper date for sort/labels
    year         = lubridate::year(date_ord),
    mmdd         = format(date_ord, "%m-%d"),
    mapped_reads = as.numeric(mapped_reads),
    total_reads  = as.numeric(total_reads),
    Normalized_Reads = ifelse(total_reads > 0, (mapped_reads / total_reads) * 1e6, NA_real_)
  ) %>%
  filter(sewershed_location == "Columbia, MO") %>%
  filter(!grepl("veterinary", virus_type, ignore.case = TRUE)) %>%
  filter(virus_type %in% c("Enteric", "Respiratory")) %>%
  # order x as the actual chronological factor (but keep original character string)
  arrange(date_ord) %>%
  mutate(time_label = factor(time_label, levels = unique(time_label)))

# 2) Virus orderings (unchanged)
Enteric_viruses_levels <- c(
  "Norovirus genogroup II", "Norovirus genogroup I", "Norovirus genogroup IV",
  "Rotavirus A", "Rotavirus B", "Rotavirus C", "Astrovirus MLB", "Astrovirus VA",
  "Human astrovirus (Other)",
  "Sapporo virus", "Aichivirus",
  "Human mastadenovirus A", "Human mastadenovirus B", "Human mastadenovirus C",
  "Human mastadenovirus D", "Human mastadenovirus F",
  "Human adenovirus F40", "Human adenovirus F41", 
  "Human picobirnavirus", "Hepatitis A"
)

Respiratory_virus_levels <- c(
  "SARS-CoV-2","Coronavirus 229E", "Coronavirus HKU1", "Coronavirus NL63",
  "Coronavirus OC43",
  "Influenza A (H1N1)", "Influenza A (H3N2)",
  "Influenza A (H5N1)","Influenza A (Other)", "Influenza B", "Influenza C",
  "Parainfluenza 1", "Parainfluenza 2",
  "Parainfluenza 3", "Parainfluenza 4", "RSV-A", "RSV-B","Human bocavirus","Metapneumovirus",
  "Enterovirus A", "Enterovirus B", "Enterovirus C", "Enterovirus D68",
  "Parechovirus A", "Rhinovirus A", "Rhinovirus B", "Rhinovirus C"
)

# 3) Helper: monthly tick positions and labels (e.g., "Jan 2024", "Feb 2025")
build_month_ticks <- function(df) {
  tmp <- df %>%
    mutate(month_label = format(date_ord, "%b %Y")) %>%
    group_by(month_label) %>%
    summarise(x_tick = first(time_label), .groups = "drop")
  list(ticks = tmp$x_tick, labels = tmp$month_label)
}

# 4) Enteric data + ticks
labkey.data_enteric <- labkey.data %>%
  filter(virus_type == "Enteric") %>%
  mutate(virus = factor(virus, levels = Enteric_viruses_levels))

ticks_enteric <- build_month_ticks(labkey.data_enteric)







# Define seasonal event dates
season_dates <- as.Date(c("2024-03-26",  # Spring Equinox
                          "2024-06-25",  # Summer Solstice
                          "2024-09-24",  # Fall Equinox
                          "2024-12-24",  # Winter Solstice
                          "2025-04-01", #should be 3-26, maybe nothing found on that day
                          "2025-06-24")) 


season_labels <- as.character(season_dates)
season_x <- match(season_labels, levels(labkey.data_enteric$time_label))


# Corresponding colors
#season_colors <- c("green", "red", "orange", "blue", "green", "red")
season_colors <- c("black","black","black","black","black","black")









EnteroHeat <- ggplot(labkey.data_enteric, aes(x = time_label, y = virus)) +
  geom_tile(aes(fill = Normalized_Reads)) +
  scale_fill_viridis_c(
    name = "Mapped Reads\nper Million",
    option = "viridis",
    trans = "log10",
    na.value = "grey90"
  ) +
  geom_hline(yintercept = seq(0.5, length(unique(labkey.data_enteric$virus)) + 0.5, 1),
             color = "lightgrey", linewidth = 0.3) +
  geom_vline(xintercept = seq(0.5, length(unique(labkey.data_enteric$time_label)) + 0.5, 1),
             color = "lightgrey", linewidth = 0.3) +
    geom_vline(xintercept = season_x - 0.5, color = season_colors, linewidth = 0.7, linetype = "dashed")+
  scale_x_discrete(
    expand = c(0, 0),
    breaks = ticks_enteric$ticks,
    labels = ticks_enteric$labels
  ) +
  scale_y_discrete(limits = rev(Enteric_viruses_levels)) +
  labs(x = "Sample Date", y = "Virus") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks.x     = element_line(color = "black"),
    axis.line        = element_blank(),
    axis.text.x      = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y      = element_text(size = 11),
    plot.title       = element_text(size = 12, face = "bold"),
    legend.position  = "right",
    legend.direction = "vertical",
    legend.text      = element_text(size = 9),
    legend.title     = element_text(size = 10)
  )



labkey.data_respiratory <- labkey.data %>%
  filter(virus_type == "Respiratory") %>%
  mutate(
    virus = case_when(
      virus %in% c("Parechovirus 3", "Parechovirus 5") ~ "Parechovirus A",
      TRUE ~ virus
    ),
    virus = factor(virus, levels = Respiratory_virus_levels)
  ) %>%
  group_by(sewershed_location, time_label, virus, date_ord, virus_type) %>%
  summarise(Normalized_Reads = sum(Normalized_Reads, na.rm = TRUE), .groups = "drop")




# 5) Respiratory data + ticks
labkey.data_respiratory <- labkey.data %>%
  filter(virus_type == "Respiratory") %>%
  mutate(virus = factor(virus, levels = Respiratory_virus_levels))

ticks_respiratory <- build_month_ticks(labkey.data_respiratory)

# OPTION A: gridline counts based on intended levels, not what's in the data
n_y <- length(Respiratory_virus_levels)
n_x <- nlevels(labkey.data_respiratory$time_label)


RespHeat <- ggplot(labkey.data_respiratory, aes(x = time_label, y = virus)) +
  geom_tile(aes(fill = Normalized_Reads)) +
  scale_fill_viridis_c(
    name = "Mapped Reads\nper Million",
    option = "viridis",
    trans = "log10",
    na.value = "grey90"
  ) +
geom_hline(yintercept = seq(0.5, n_y + 0.5, 1),
           color = "lightgrey", linewidth = 0.3) +
geom_vline(xintercept = seq(0.5, n_x + 0.5, 1),
           color = "lightgrey", linewidth = 0.3) +
    geom_vline(xintercept = season_x - 0.5, color = season_colors, linewidth = 0.7, linetype = "dashed") +
  scale_x_discrete(
    expand = c(0, 0),
    breaks = ticks_respiratory$ticks,
    labels = ticks_respiratory$labels
  ) +
  scale_y_discrete(limits = rev(Respiratory_virus_levels)) +
  labs(x = "Sample Date", y = "Virus") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line        = element_blank(),
    axis.ticks.x     = element_line(color = "black"),
    axis.text.x      = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y      = element_text(size = 11),
    plot.title       = element_text(size = 12, face = "bold"),
    legend.position  = "right",
    legend.direction = "vertical",
    legend.text      = element_text(size = 9),
    legend.title     = element_text(size = 10)
  )



# Enteric heatmap
ggsave("./ManuscriptFigures/EntericHeatMap.png",
       plot = EnteroHeat,
       width = 8,
       height = 6,
       dpi = 300)

ggsave("./ManuscriptFigures/EntericHeatMap.tiff",
       plot = EnteroHeat,
       width = 8,
       height = 6,
       dpi = 600,
       compression = "lzw")

# Respiratory heatmap
ggsave("./ManuscriptFigures/RespHeatMap.png",
       plot = RespHeat,
       width = 8,
       height = 6,
       dpi = 300)

ggsave("./ManuscriptFigures/RespHeatMap.tiff",
       plot = RespHeat,
       width = 8,
       height = 6,
       dpi = 600,
       compression = "lzw")


```

make specific virus nvd heatmap
```{r}
# Define regex for rhinovirus serotypes
rhino_serotype_pattern <- regex("rhinovirus [a-zA-Z]*\\d{1,3}", ignore_case = TRUE)

# Replace and drop unresolved HRV sp.
etl_data2 <- etl_data %>%
  mutate(
    species = case_when(
      species == "Human rhinovirus sp." &
        str_detect(rank, rhino_serotype_pattern) ~ str_extract(rank, rhino_serotype_pattern),
      TRUE ~ species
    )
  ) %>%
  # remove anything still unresolved
  filter(species != "Human rhinovirus sp.")


# Identify top 10 rhinovirus species (based on total mapped_reads)
top10_rhino <- etl_data2 %>%
  filter(sewershed_location == "Columbia, MO") %>%
  filter(str_detect(species, regex("rhinovirus", ignore_case = TRUE))) %>%
  filter(!species %in% c("Rhinovirus A", "Rhinovirus C")) %>%
  group_by(species) %>%
  summarise(total_mapped = sum(mapped_reads, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(total_mapped)) %>%
  slice_head(n = 10) %>%
  pull(species) 

top10_rhino_ordered <- c("rhinovirus C11", "rhinovirus A22", "rhinovirus A106","rhinovirus C1","rhinovirus A58","rhinovirus A18", "rhinovirus A68", "rhinovirus C42",
                           "rhinovirus A61",
                           "rhinovirus A30")


# Define your virus list manually + top 10 rhino
specific_respiratory_viruses <- c(
  "SARS-CoV-2", "Coronavirus 229E", "Coronavirus HKU1", "Coronavirus NL63", "Coronavirus OC43",
  "Influenza A (H1N1)", "Influenza A (H3N2)", "Influenza B", "Influenza C",
  "Parainfluenza 3", "Enterovirus D68", "Parechovirus 3", "Parechovirus 5"
)

# Add rhinovirus species as separate rows
labkey_rhinos <- etl_data2 %>%
  filter(sewershed_location == "Columbia, MO",
         species %in% top10_rhino) %>%
  group_by(sample_date, species, total_reads) %>%
  summarise(mapped_reads = sum(mapped_reads, na.rm = TRUE), .groups = "drop") %>%
  mutate(virus_type = "Respiratory",
         virus = species,
         time_label = as.character(sample_date),
         Normalized_Reads = ifelse(total_reads > 0, (mapped_reads / total_reads) * 1e6, NA_real_),
         date_ord = lubridate::ymd(sample_date))

# Pull the corresponding cleaned viruses from labkey.data
labkey_specific <- labkey.data %>%
  filter(virus %in% specific_respiratory_viruses)

# Combine both
labkey_targeted <- bind_rows(
  labkey_specific %>%
    select(time_label, virus, date_ord, Normalized_Reads, virus_type),
  labkey_rhinos %>%
    select(time_label, virus, date_ord, Normalized_Reads, virus_type)
) %>%
  mutate(
    time_label = factor(time_label, levels = unique(sort(time_label)))
  )





labkey_targeted <- labkey_targeted %>%
  mutate(
    virus = str_replace(virus, regex("^rhinovirus", ignore_case = TRUE), "Rhinovirus")
  )
top10_rhino_ordered <- str_replace(top10_rhino_ordered, 
                                   regex("^rhinovirus", ignore_case = TRUE), 
                                   "Rhinovirus")




# Optional: Define y-axis virus order
virus_order_custom <- c(
  "SARS-CoV-2", "Coronavirus 229E", "Coronavirus HKU1", "Coronavirus NL63", "Coronavirus OC43",
  "Influenza A (H1N1)", "Influenza A (H3N2)", "Influenza B", "Influenza C",
  "Parainfluenza 3",  "Enterovirus D68",
  "Parechovirus 5", "Parechovirus 3",
  top10_rhino_ordered
)


# Monthly ticks
ticks_custom <- build_month_ticks(labkey_targeted)

# Find transition point between years
year_transitions <- labkey_targeted %>%
  arrange(date_ord) %>%
  mutate(prev_year = lag(lubridate::year(date_ord)),
         curr_year = lubridate::year(date_ord)) %>%
  filter(!is.na(prev_year) & curr_year != prev_year) %>%
  slice(1)

vline_x <- as.character(year_transitions$time_label)



# reversed levels used in the plot
rev_levels <- rev(virus_order_custom)

# define groups as vectors of virus names in your new structure
group_list <- list(
  corona   = c("SARS-CoV-2", "Coronavirus 229E", "Coronavirus HKU1", "Coronavirus NL63", "Coronavirus OC43"),
  flu = c("Influenza A (H1N1)", "Influenza A (H3N2)", "Influenza B", "Influenza C" ),
  paraflu = c("Parainfluenza 3"), 
  entero   = c("Enterovirus D68"),
  parecho  = c("Parechovirus 5", "Parechovirus 3"),
  rhino    = top10_rhino
)
group_list$rhino <- str_replace(group_list$rhino, regex("^rhinovirus", ignore_case = TRUE), "Rhinovirus")


# find indices of the last item in each group
group_end_indices <- sapply(group_list, function(gr) max(match(gr, rev_levels)))

# convert to hline positions (between rows)
hline_positions <- group_end_indices + 0.5


# Define seasonal event dates
season_dates <- as.Date(c("2024-03-26",  # Spring Equinox
                          "2024-06-25",  # Summer Solstice
                          "2024-09-24",  # Fall Equinox
                          "2024-12-24",  # Winter Solstice
                          "2025-04-01", #should be 3-26, maybe nothing found on that day
                          "2025-06-24")) 

# Match to time_label factor levels for positioning
season_labels <- as.character(season_dates)
season_x <- match(season_labels, levels(labkey_targeted$time_label))

# Corresponding colors
#season_colors <- c("green", "red", "orange", "blue", "green", "red")
season_colors <- c("black","black","black","black","black","black")


# Plot
RespSpecificHeat <- ggplot(labkey_targeted, aes(x = time_label, y = factor(virus, levels = rev(virus_order_custom)))) +
  geom_tile(aes(fill = Normalized_Reads)) +
  scale_fill_viridis_c(
    name = "Mapped Reads\nper Million",
    option = "viridis",
    trans = "log10",
    na.value = "grey90"
  ) +
  geom_hline(yintercept = seq(0.5, length(virus_order_custom) + 0.5, 1),
             color = "lightgrey", linewidth = 0.3) +
  geom_hline(yintercept = hline_positions, color = "lightgrey", linewidth = 2) +
  
  geom_vline(xintercept = seq(0.5, length(unique(labkey_targeted$time_label)) + 0.5, 1),
             color = "lightgrey", linewidth = 0.3) +
  geom_vline(xintercept = season_x - 0.5, color = season_colors, linewidth = 0.7, linetype = "dashed")+
  #geom_vline(xintercept = which(levels(labkey_targeted$time_label) == vline_x) - 0.5,color = "black", linewidth = 1)+
  scale_x_discrete(
    expand = c(0, 0),
    breaks = ticks_custom$ticks,
    labels = ticks_custom$labels
  ) +
  labs(x = "Sample Date", y = "Virus") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line        = element_blank(),
    axis.ticks.x     = element_line(color = "black"),
    axis.text.x      = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y      = element_text(size = 11),
    plot.title       = element_text(size = 12, face = "bold"),
    legend.position  = "right",
    legend.direction = "vertical",
    legend.text      = element_text(size = 9),
    legend.title     = element_text(size = 10)
  )

ggsave("./Figures6/RespSpecificHeatMap.png", plot = RespSpecificHeat, width = 8, height = 6, dpi = 300)


# Respiratory-specific heatmap
ggsave("./ManuscriptFigures/RespSpecificHeatMap.png",
       plot = RespSpecificHeat,
       width = 8,
       height = 6,
       dpi = 300)

ggsave("./ManuscriptFigures/RespSpecificHeatMap.tiff",
       plot = RespSpecificHeat,
       width = 8,
       height = 6,
       dpi = 600,
       compression = "lzw")


```


Load in gottcha data
```{r}
#Gottcha for full samples
gottcha2024 <- read_tsv("./20250424g2/reads.specv2.full.tsv")


# Rename columns
colnames(gottcha2024)[3] <- "Kingdom"
colnames(gottcha2024)[6] <- "Phylum"
colnames(gottcha2024)[9] <- "Class"
colnames(gottcha2024)[12] <- "Order"
colnames(gottcha2024)[15] <- "Family"
colnames(gottcha2024)[18] <- "Genus"
colnames(gottcha2024)[21] <- "Species"
colnames(gottcha2024)[22] <- "SpeciesName"

# Remove unnecessary columns
gottcha2024 <- gottcha2024 %>% select(-c(1, 2, 4, 5, 7, 8, 10, 11, 13, 14, 16, 17, 19, 20))
# Remove "MEAN" "SUM" "VAR" and "VAR_PER" columns
gottcha2024 <- gottcha2024 %>% select(-c("MEAN", "SUM", "VAR", "VAR_PER"))

#manually add taxonomic info for some rows in gottcha2024. First, for rows with "Athelia psychrophila" in the SpeciesName column add Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class, Atheliales to Order, and Atheliaceae to Family, Athelia to Genus, and Athelia psychrophila to Species
gottcha2024$Kingdom[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Eukaryota"
gottcha2024$Phylum[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Basidiomycota"
gottcha2024$Class[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Agaricomycetes"
gottcha2024$Order[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Atheliales"
gottcha2024$Family[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Atheliaceae"
gottcha2024$Genus[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Athelia"
gottcha2024$Species[gottcha2024$SpeciesName == "Athelia psychrophila"] <- "Athelia psychrophila"
#manually add taxonomic info for Hirschioporus abietinus. Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class,  Hymenochaetales to Order, Hirschioporaceae to Family, Hirschioporus to Genus, and Hirschioporus abietinus to Species
gottcha2024$Kingdom[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Eukaryota"
gottcha2024$Phylum[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Basidiomycota"
gottcha2024$Class[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Agaricomycetes"
gottcha2024$Order[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Hymenochaetales"
gottcha2024$Family[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Hirschioporaceae"
gottcha2024$Genus[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Hirschioporus"
gottcha2024$Species[gottcha2024$SpeciesName == "Hirschioporus abietinus"] <- "Hirschioporus abietinus"
#manually add taxonomic info for Leucogyrophana pinastri. Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class,  Boletales to Order, no_family_rank to Family, Leucogyrophana to Genus, and Leucogyrophana pinastri to Species
gottcha2024$Kingdom[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "Eukaryota"
gottcha2024$Phylum[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "Basidiomycota"
gottcha2024$Class[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "Agaricomycetes"
gottcha2024$Order[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "Boletales"
gottcha2024$Family[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "no_family_rank"
gottcha2024$Genus[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "Leucogyrophana"
gottcha2024$Species[gottcha2024$SpeciesName == "Leucogyrophana pinastri"] <- "Leucogyrophana pinastri"
#manually add taxonomic info for Phlebiella vaga. Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class,   Corticiales to Order, Corticiaceae to Family, Phlebiella to Genus, and Phlebiella vaga to Species
gottcha2024$Kingdom[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Eukaryota"
gottcha2024$Phylum[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Basidiomycota"
gottcha2024$Class[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Agaricomycetes"
gottcha2024$Order[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Corticiales"
gottcha2024$Family[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Corticiaceae"
gottcha2024$Genus[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Phlebiella"
gottcha2024$Species[gottcha2024$SpeciesName == "Phlebiella vaga"] <- "Phlebiella vaga"
#manually add taxonomic info for Podospora conica. Eukaryota to Kingdom, Ascomycota to Phylum, Sordariomycetes to class,  Sordariales to Order, Podosporaceae to Family, Podospora to Genus, and Podospora conica to Species
gottcha2024$Kingdom[gottcha2024$SpeciesName == "Podospora conica"] <- "Eukaryota"
gottcha2024$Phylum[gottcha2024$SpeciesName == "Podospora conica"] <- "Ascomycota"
gottcha2024$Class[gottcha2024$SpeciesName == "Podospora conica"] <- "Sordariomycetes"
gottcha2024$Order[gottcha2024$SpeciesName == "Podospora conica"] <- "Sordariales"
gottcha2024$Family[gottcha2024$SpeciesName == "Podospora conica"] <- "Podosporaceae"
gottcha2024$Genus[gottcha2024$SpeciesName == "Podospora conica"] <- "Podospora"
gottcha2024$Species[gottcha2024$SpeciesName == "Podospora conica"] <- "Podospora conica"





#gottcha2025 for full samples
gottcha2025 <- read_tsv("./20250822g2/reads.specv2.full.tsv")



# Rename columns
colnames(gottcha2025)[3] <- "Kingdom"
colnames(gottcha2025)[6] <- "Phylum"
colnames(gottcha2025)[9] <- "Class"
colnames(gottcha2025)[12] <- "Order"
colnames(gottcha2025)[15] <- "Family"
colnames(gottcha2025)[18] <- "Genus"
colnames(gottcha2025)[21] <- "Species"
colnames(gottcha2025)[22] <- "SpeciesName"

# Remove unnecessary columns
gottcha2025 <- gottcha2025 %>% select(-c(1, 2, 4, 5, 7, 8, 10, 11, 13, 14, 16, 17, 19, 20))
# Remove "MEAN" "SUM" "VAR" and "VAR_PER" columns
gottcha2025 <- gottcha2025 %>% select(-c("MEAN", "SUM", "VAR", "VAR_PER"))

#manually add taxonomic info for some rows in gottcha2025. First, for rows with "Athelia psychrophila" in the SpeciesName column add Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class, Atheliales to Order, and Atheliaceae to Family, Athelia to Genus, and Athelia psychrophila to Species
gottcha2025$Kingdom[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Eukaryota"
gottcha2025$Phylum[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Basidiomycota"
gottcha2025$Class[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Agaricomycetes"
gottcha2025$Order[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Atheliales"
gottcha2025$Family[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Atheliaceae"
gottcha2025$Genus[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Athelia"
gottcha2025$Species[gottcha2025$SpeciesName == "Athelia psychrophila"] <- "Athelia psychrophila"
#manually add taxonomic info for Hirschioporus abietinus. Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class,  Hymenochaetales to Order, Hirschioporaceae to Family, Hirschioporus to Genus, and Hirschioporus abietinus to Species
gottcha2025$Kingdom[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Eukaryota"
gottcha2025$Phylum[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Basidiomycota"
gottcha2025$Class[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Agaricomycetes"
gottcha2025$Order[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Hymenochaetales"
gottcha2025$Family[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Hirschioporaceae"
gottcha2025$Genus[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Hirschioporus"
gottcha2025$Species[gottcha2025$SpeciesName == "Hirschioporus abietinus"] <- "Hirschioporus abietinus"
#manually add taxonomic info for Leucogyrophana pinastri. Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class,  Boletales to Order, no_family_rank to Family, Leucogyrophana to Genus, and Leucogyrophana pinastri to Species
gottcha2025$Kingdom[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "Eukaryota"
gottcha2025$Phylum[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "Basidiomycota"
gottcha2025$Class[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "Agaricomycetes"
gottcha2025$Order[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "Boletales"
gottcha2025$Family[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "no_family_rank"
gottcha2025$Genus[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "Leucogyrophana"
gottcha2025$Species[gottcha2025$SpeciesName == "Leucogyrophana pinastri"] <- "Leucogyrophana pinastri"
#manually add taxonomic info for Phlebiella vaga. Eukaryota to Kingdom, Basidiomycota to Phylum, Agaricomycetes to class,   Corticiales to Order, Corticiaceae to Family, Phlebiella to Genus, and Phlebiella vaga to Species
gottcha2025$Kingdom[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Eukaryota"
gottcha2025$Phylum[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Basidiomycota"
gottcha2025$Class[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Agaricomycetes"
gottcha2025$Order[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Corticiales"
gottcha2025$Family[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Corticiaceae"
gottcha2025$Genus[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Phlebiella"
gottcha2025$Species[gottcha2025$SpeciesName == "Phlebiella vaga"] <- "Phlebiella vaga"
#manually add taxonomic info for Podospora conica. Eukaryota to Kingdom, Ascomycota to Phylum, Sordariomycetes to class,  Sordariales to Order, Podosporaceae to Family, Podospora to Genus, and Podospora conica to Species
gottcha2025$Kingdom[gottcha2025$SpeciesName == "Podospora conica"] <- "Eukaryota"
gottcha2025$Phylum[gottcha2025$SpeciesName == "Podospora conica"] <- "Ascomycota"
gottcha2025$Class[gottcha2025$SpeciesName == "Podospora conica"] <- "Sordariomycetes"
gottcha2025$Order[gottcha2025$SpeciesName == "Podospora conica"] <- "Sordariales"
gottcha2025$Family[gottcha2025$SpeciesName == "Podospora conica"] <- "Podosporaceae"
gottcha2025$Genus[gottcha2025$SpeciesName == "Podospora conica"] <- "Podospora"
gottcha2025$Species[gottcha2025$SpeciesName == "Podospora conica"] <- "Podospora conica"








gottcha <- merge(gottcha2024, gottcha2025, by = colnames(gottcha2024)[1:8], all = TRUE)

# Convert all NA values to 0 from the 10th column to ncol(gottcha2025) in gottcha2025
#gottcha2025[is.na(gottcha2025)] <- 0
# Replace NA values with 0 from the 10th column onward
gottcha[, 9:ncol(gottcha)] <- lapply(gottcha[, 9:ncol(gottcha)], function(x) {
  ifelse(is.na(x), 0, x)
})

non_normalized_gottcha <- gottcha

#for normalizing by sample depth
SampleDepth <- Fig1a_long |> 
  select(SampleID, TotalReads) |>
  distinct()|>
  mutate(SampleID= str_remove(SampleID, "^Columbia_MO_"))|>
  pivot_wider(names_from = SampleID, values_from = TotalReads)

sample_cols <- 9:ncol(gottcha)
gottcha[, sample_cols] <- sweep(gottcha[, sample_cols], 2, as.numeric(SampleDepth[1, colnames(gottcha)[sample_cols]]), "/") * 1e6



#fix sample column names
# Identify sample columns (assumes they start with "20")
sample_cols <- grep("^20\\d{6}$", colnames(gottcha), value = TRUE)

# Format them to "yyyy-mm-dd"
formatted_names <- gsub("(\\d{4})(\\d{2})(\\d{2})", "\\1-\\2-\\3", sample_cols)

# Rename in the dataframe
colnames(gottcha)[match(sample_cols, colnames(gottcha))] <- formatted_names

write.table(gottcha, file = "gottcha.tsv", 
            sep = "\t", row.names = FALSE, quote = FALSE)

```

Determine percent assigned seqeunces from gottcha
```{r}
# Sum classified sequences for each sample (columns 9 onward)
classified_sums <- colSums(non_normalized_gottcha[ , 9:ncol(non_normalized_gottcha)])

# Extract sample depths from your single-row dataframe
depths <- as.numeric(SampleDepth[1, ])
names(depths) <- colnames(SampleDepth)

# Make sure both vectors have the same sample order
common_samples <- intersect(names(classified_sums), names(depths))

# Calculate proportions only on common samples
proportion_classified <- classified_sums[common_samples] / depths[common_samples]

# Build tidy dataframe
Gottchaclassifiedproportions <- data.frame(
  Sample = common_samples,
  Proportion_Classified = as.numeric(proportion_classified),
  Classified_Counts = as.numeric(classified_sums[common_samples]),
  Total_Depth = as.numeric(depths[common_samples])
)

print(Gottchaclassifiedproportions)

# Calculate percent classified
percent_classified <- Gottchaclassifiedproportions$Proportion_Classified * 100

# Summaries
avg <- mean(percent_classified, na.rm = TRUE)
mx  <- max(percent_classified, na.rm = TRUE)
mn  <- min(percent_classified, na.rm = TRUE)
sdv <- sd(percent_classified, na.rm = TRUE)

# Print nicely
cat("Average % classified:", avg, "\n")
cat("Max % classified:", mx, "\n")
cat("Min % classified:", mn, "\n")
cat("SD % classified:", sdv, "\n")

```

Make NVD dataframe for NMDS
```{r}

nvdwithlineage <- etl_data %>%
  select("sample_date", "Sample Id", "stitle", "Length", "species", "rank", "mapped_reads", "total_reads") %>%
  
  # Rename species to avoid name collision
  rename(NVDspecies = species) %>%
  
  # Add unique row identifier
  mutate(row_id = row_number()) %>%
  
  # Split the rank string by "; " into individual taxon entries
  mutate(rank = strsplit(as.character(rank), ";\\s*")) %>%
  unnest(rank) %>%
  
  # Split on the first colon only
  mutate(
    Level = str_extract(rank, "^[^:]+"),
    Name = str_replace(rank, "^[^:]+:", "")
  ) %>%
  
  # Remove duplicate taxonomy levels per row
  distinct(row_id, Level, .keep_all = TRUE) %>%
  
  # Pivot wider to turn taxonomy levels into columns
  pivot_wider(
    id_cols = c("row_id", "sample_date", "Sample Id", "stitle", "Length", "NVDspecies", "mapped_reads", "total_reads"),
    names_from = Level,
    values_from = Name,
    values_fn = list,            # handles repeated levels safely
    names_repair = "unique"      # avoids name duplication errors
  )



```

Make all NMDS dataframes
```{r}

###Make dataframes for NMDS

#NVD full output
nvd_norm <- nvdwithlineage %>%
  mutate(norm_mapped_reads = (mapped_reads / total_reads) * 1e6) %>%
  select(sample_date, species, norm_mapped_reads) %>%
  mutate(species = unlist(species)) %>%  # <-- Move here
  group_by(sample_date, species) %>%
  summarise(total_norm_mapped_reads = sum(norm_mapped_reads, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = sample_date,
    values_from = total_norm_mapped_reads,
    values_fill = 0
  )

#check to make sure species column does not contain more then one species per row
#which(lengths(nvd_norm$species) > 1)


# Set rownames and transpose
nvd_matrix <- nvd_norm %>%
  column_to_rownames("species") %>%    # species become row names
  t()                                  # transpose




#Total gottcha
gottcha_matrix <- gottcha %>%
  select(Species, starts_with("20")) %>%  # adjust column matcher if needed
  column_to_rownames("Species") %>%
  t()


#Gottcha viruses 
gottcha_virus_matrix <- gottcha %>%
  filter(Kingdom == "Viruses") |>
  select(Species, starts_with("20")) %>%  # adjust column matcher if needed
  column_to_rownames("Species") %>%
  t()


#Gottcha Bacteria 
gottcha_bacteria_matrix <- gottcha %>%
  filter(Kingdom == "Bacteria") |>
  select(Species, starts_with("20")) %>%  # adjust column matcher if needed
  column_to_rownames("Species") %>%
  t()


#Gottcha NVD specific viruses

# Define the list of specific virus families
specific_virus_families <- c(
  "Adenoviridae", "Anelloviridae", "Arenaviridae", "Arteriviridae", "Astroviridae",
  "Bornaviridae", "Peribunyaviridae", "Caliciviridae", "Coronaviridae", "Filoviridae",
  "Flaviviridae", "Hepadnaviridae", "Hepeviridae", "Orthoherpesviridae", "Orthomyxoviridae",
  "Papillomaviridae", "Paramyxoviridae", "Parvoviridae", "Picobirnaviridae", "Picornaviridae",
  "Pneumoviridae", "Polyomaviridae", "Poxviridae", "Sedoreoviridae", "Retroviridae",
  "Rhabdoviridae", "Togaviridae", "Kolmioviridae"
)

gottcha_NVDvirus_matrix <- gottcha %>%
  filter(Family %in% specific_virus_families) %>%
  select(Species, starts_with("20")) %>%
  column_to_rownames("Species") %>%
  t()


shared_samples <- Reduce(intersect, list(
  rownames(nvd_matrix),
  rownames(gottcha_matrix),
  rownames(gottcha_virus_matrix),
  rownames(gottcha_bacteria_matrix),
  rownames(gottcha_NVDvirus_matrix)
))

# Apply to all matrices
nvd_matrix <- nvd_matrix[shared_samples, ]
gottcha_matrix <- gottcha_matrix[shared_samples, ]
gottcha_virus_matrix <- gottcha_virus_matrix[shared_samples, ]
gottcha_bacteria_matrix <- gottcha_bacteria_matrix[shared_samples, ]
gottcha_NVDvirus_matrix <- gottcha_NVDvirus_matrix[shared_samples, ]




```

Make NMDS plots
```{r}
library(vegan)
library(ggplot2)
library(lubridate)
library(cowplot)

assign_season <- function(dates) {
  dates <- ymd(dates)
  get_season <- function(date) {
    y <- year(date)
    spring_start <- ymd(paste0(y, "-03-20"))
    summer_start <- ymd(paste0(y, "-06-21"))
    fall_start   <- ymd(paste0(y, "-09-22"))
    winter_start <- ymd(paste0(y, "-12-21"))

    if (date >= spring_start & date < summer_start) {
      return("Spring")
    } else if (date >= summer_start & date < fall_start) {
      return("Summer")
    } else if (date >= fall_start & date < winter_start) {
      return("Fall")
    } else {
      return("Winter")
    }
  }
  return(vapply(dates, get_season, character(1)))
}

run_nmds_plot <- function(mat, title) {
  abundance <- as.data.frame(mat)
  sample_dates <- ymd(rownames(abundance))
  if (any(is.na(sample_dates))) {
    stop("Some dates could not be parsed from rownames. Expected yyyy-mm-dd format.")
  }

  dist_bray <- vegdist(abundance, method = "bray")
  nmds <- metaMDS(dist_bray, k = 2, trymax = 200)

  nmds_df <- as.data.frame(nmds$points)
  nmds_df$Date   <- sample_dates
  nmds_df$Season <- assign_season(nmds_df$Date)
  nmds_df$Year   <- year(nmds_df$Date)
  nmds_df$SeasonYear <- paste(nmds_df$Season, nmds_df$Year)

  # Legend order
  seasonyear_levels <- c(
    "Winter 2024", "Spring 2024", "Summer 2024", "Fall 2024",
    "Winter 2025", "Spring 2025", "Summer 2025"
  )
  nmds_df$SeasonYear <- factor(nmds_df$SeasonYear, levels = seasonyear_levels)

  # Color and shape mapping
  season_cols <- c(Winter = "blue", Spring = "green", Summer = "red", Fall = "orange")
  sy_levels <- levels(nmds_df$SeasonYear)
  col_map_sy <- setNames(season_cols[sub(" .*$", "", sy_levels)], sy_levels)
  col_map <- c(season_cols, col_map_sy)
  shape_map <- setNames(ifelse(grepl(" 2024$", sy_levels), 1, 16), sy_levels)

  # PERMANOVA (season only)
  adonis_res <- adonis2(dist_bray ~ Season, data = nmds_df, by = "margin")

  plot <- ggplot(nmds_df, aes(x = MDS1, y = MDS2,
                              color = SeasonYear, shape = SeasonYear)) +
    geom_point(size = 1.8, stroke = 0.6) +
    #stat_ellipse(
    #  data = nmds_df,
    #  aes(x = MDS1, y = MDS2, color = Season, group = Season),
    #  level = 0.95, linewidth = 0.6, show.legend = FALSE,
    #  inherit.aes = FALSE
    #) +
    scale_color_manual(values = col_map, breaks = sy_levels, name = "Season–Year") +
    scale_shape_manual(values = shape_map, breaks = sy_levels, name = "Season–Year") +
    labs(
      title = title,
      subtitle = paste0("Stress = ", round(nmds$stress, 3),
                        "; PERMANOVA p = ", signif(adonis_res$`Pr(>F)`[1], 3)),
      x = "NMDS Axis 1",
      y = "NMDS Axis 2"
    ) +
    theme_minimal() +
    theme(
      legend.position = "right",
      axis.text = element_text(size = 10),
      axis.title = element_text(size = 11),
      plot.title = element_text(size = 12),
      plot.subtitle = element_text(size = 8)
    )

  list(
    plot = plot,
    nmds = nmds,
    data = nmds_df,
    dist_bray = dist_bray,
    abundance = abundance,
    adonis = adonis_res,
    adonis_table = as.data.frame(adonis_res)
  )
}

# Run NMDS and store full output
nmds_nvd <- run_nmds_plot(nvd_matrix, "NVD")
nmds_gottcha_NVDvirus <- run_nmds_plot(gottcha_NVDvirus_matrix, "GOTTCHA2")

# Composite figure
left_plot <- nmds_nvd$plot +
  theme(legend.position = "none", plot.margin = margin(5, 5, 5, 2))
right_plot <- nmds_gottcha_NVDvirus$plot +
  theme(plot.margin = margin(5, 2, 5, 5))

nmds_compoiste <- plot_grid(left_plot, right_plot, 
                            ncol = 2,
                            align = "h",
                            axis = "lr",
                            rel_heights = c(1,1),
                            rel_widths = c(.7 , 1),
                            labels = c("A", "B"),
                            label_size = 13,
                            label_fontface = "bold",
                            label_y = c(1,1))



# Composite NMDS plot
ggsave("./ManuscriptFigures/composite_plot_nmds.png",
       plot = nmds_compoiste,
       width = 7,
       height = 3,
       dpi = 300)

ggsave("./ManuscriptFigures/composite_plot_nmds.tiff",
       plot = nmds_compoiste,
       width = 7,
       height = 3,
       dpi = 600,
       compression = "lzw")

# New PERMANOVA wrapper to test seasonal repeatability
print_permanova_report <- function(nmds_result, dataset_label) {
  cat("\n\n============ PERMANOVA Summary for", dataset_label, "============\n\n")

  # Full model (already run in main function)
  cat("---- Full dataset (all seasons): ----\n")
  print(nmds_result$adonis)

  # Season-only model across *all data*
  cat("\nPERMANOVA: Season only (all data)\n")
  dist_full <- nmds_result$dist_bray
  df_full <- nmds_result$data
  df_full$Season <- factor(df_full$Season)
  print(adonis2(dist_full ~ Season, data = df_full))

  # Check coverage
  years_by_season <- table(nmds_result$data$Season, nmds_result$data$Year)
  if (any(rownames(years_by_season) %in% c("Summer", "Fall")) &&
      any(colnames(years_by_season) %in% "2025") &&
      any(years_by_season[c("Summer", "Fall"), "2025"] == 0)) {
    cat("\n[Warning] Incomplete data for Summer/Fall 2025. Interpret with caution.\n")
  }

  # Subset to Winter + Spring
  df_ws <- subset(nmds_result$data, Season %in% c("Winter", "Spring"))
  abund_ws <- nmds_result$abundance[rownames(nmds_result$abundance) %in% rownames(df_ws), ]
  dist_ws <- vegdist(abund_ws, method = "bray")

  df_ws$Season <- factor(df_ws$Season)
  df_ws$Year <- factor(df_ws$Year)

  cat("\n---- Subset: Winter + Spring only ----\n")

  # Season only
  cat("\nPERMANOVA: Season only\n")
  print(adonis2(dist_ws ~ Season, data = df_ws))

  # Year only
  cat("\nPERMANOVA: Year only\n")
  print(adonis2(dist_ws ~ Year, data = df_ws))

  # Season * Year interaction
  cat("\nPERMANOVA: Season * Year interaction\n")
  print(adonis2(dist_ws ~ Season * Year, data = df_ws, by = "margin"))
}


# Run PERMANOVA reports
print_permanova_report(nmds_nvd, "A: NVD")
print_permanova_report(nmds_gottcha_NVDvirus, "B: GOTTCHA + NVD Viruses")

```

Make Prokayote/Eukaryote abundance graphs with gottcha
```{r}
library(scales)
library(viridisLite)

# Define a function to truncate a viridis-like palette
truncate_palette <- function(palette_func, n = 6, from = 0.25, to = 0.75) {
  values <- seq(from, to, length.out = n)
  palette_func(256)[round(values * 255) + 1]
}

# Get truncated 6-color palettes
mako_truncated <- truncate_palette(mako, n = 8, from = 0.1, to = 0.85)
rocket_truncated <- truncate_palette(rocket, n = 8, from = 0.1, to = 0.85)

# View them
mako_truncated
rocket_truncated


hostdomains <- read.csv("Phylum_Host_Annotation.csv")
#Select columns "Phylum" and "HostDomain"
hostdomains <- hostdomains %>% select(Phylum, HostDomain)
#merge hostdomains with gottcha_viruses and move the HostDomain column to the front
gottcha_viruses_w_hosts <- gottcha %>% 
  filter(Kingdom == "Viruses") |>
  left_join(hostdomains, by = "Phylum") %>% 
  select(HostDomain, everything())
# Step 1: Remove the Virgaviridae family
#viruses_no_virgaviridae <- gottcha_viruses_w_hosts %>%
#  filter(Family != "Virgaviridae")

NoPhylum <- gottcha |>
  filter(Kingdom =="Viruses") |> filter(str_detect(Phylum, "no_p_rank"))

# Step 2: Split the dataframe into Prokaryote and Eukaryote based on HostDomain
prokaryote_viruses <- gottcha_viruses_w_hosts %>%
  filter(HostDomain == "Prokaryote")

eukaryote_viruses <- gottcha_viruses_w_hosts %>%
  filter(HostDomain == "Eukaryote")

eukaryote_viruses_no_virga <- eukaryote_viruses %>%
  filter(Family != "Virgaviridae")


process_top_families <- function(df, tax_cols_start, sample_cols_start) {
  tax_cols <- tax_cols_start:(sample_cols_start - 1)
  sample_cols <- sample_cols_start:ncol(df)
  
  # Identify rows that do NOT contain "no_f_rank" for determining top families
  top_families <- df %>%
    filter(!str_detect(Family, "no_f_rank")) %>%
    group_by(Family) %>%
    summarise(across(all_of(names(df)[sample_cols]), sum), .groups = "drop") %>%
    mutate(total_abundance = rowSums(across(-Family))) %>%
    arrange(desc(total_abundance)) %>%
    slice_head(n = 7) %>%
    pull(Family)

  # Label as "Other" if not in top families OR contains "no_f_rank"
  df_top <- df %>%
    mutate(Family = ifelse(Family %in% top_families & !str_detect(Family, "no_f_rank"), Family, "Other"))

  # Make sure 'Other' appears last in the legend
  df_top$Family <- factor(df_top$Family, levels = c(setdiff(top_families, "Other"), "Other"))

  # Aggregate again by Family
  family_abundances <- df_top %>%
    group_by(Family) %>%
    summarise(across(all_of(names(df)[sample_cols]), sum), .groups = "drop")

  # Long format
  long_df <- family_abundances %>%
    pivot_longer(
      cols = -Family,
      names_to = "SampleDate",
      values_to = "Abundance"
    )

  # Relative abundance
  relative_df <- long_df %>%
    group_by(SampleDate) %>%
    mutate(RelAbundance = Abundance / sum(Abundance)) %>%
    ungroup()

  return(relative_df)
}


# Step 4: Process Prokaryote viruses
relative_df_prokaryote <- process_top_families(prokaryote_viruses, 2, 10)

#Remove rows with "Sum" in the SampleDate column
relative_df_prokaryote <- relative_df_prokaryote %>% filter(SampleDate != "Sum")







# Step 5: Process Eukaryote viruses
relative_df_eukaryote <- process_top_families(eukaryote_viruses, 2, 10)

#Remove rows with "Sum" in the SampleDate column
relative_df_eukaryote <- relative_df_eukaryote %>% filter(SampleDate != "Sum")



# Eukaryote plot with no axis titles or x-axis text
eukabundance <- ggplot(relative_df_eukaryote, aes(x = SampleDate, y = RelAbundance, fill = Family)) +
  geom_bar(stat = "identity", position = "stack") +
scale_fill_viridis_d(option = "plasma", direction = -1, begin = 0.1, end = 0.85) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  labs(
    #title = "Top 5 Viral Families (Eukaryote Hosts)"
    y = "Relative Abundance (%)",
    x = NULL,
    fill = "Eukaryotic\nViral Family"
  ) +
  theme(text = element_text(size = 11),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.width = unit(.5, "cm"),
    legend.text = element_text(size = 8),  # reduce text
  legend.title = element_text(size = 9)  # reduce title
  )





# Step 6: Compare Prokaryote vs Eukaryote abundance over time

# Gather abundance per HostDomain per sample
host_abundance <- gottcha_viruses_w_hosts %>%
  select(HostDomain, starts_with("20")) %>%  # adjust this if your sample columns start with something else
  filter(HostDomain %in% c("Prokaryote", "Eukaryote")) %>%
  group_by(HostDomain) %>%
  summarise(across(everything(), sum)) %>%
  pivot_longer(-HostDomain, names_to = "SampleDate", values_to = "Abundance") %>%
  group_by(SampleDate) %>%
  mutate(RelAbundance = Abundance / sum(Abundance)) %>%
  ungroup()


# Plot relative abundance of Prokaryote vs Eukaryote
hostdomain_plot <- ggplot(host_abundance, aes(x = SampleDate, y = RelAbundance, fill = HostDomain)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(Prokaryote = "#0072B2",  
                             Eukaryote = "#D55E00")) + 
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  labs(
    #title = "Relative Abundance: Prokaryote vs Eukaryote Infecting Viruses"
    x = NULL,
    y = "Relative Abundance (%)",
    fill = "Virus Host\nDomain"
  ) +
  theme(text = element_text(size = 11),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.width = unit(.5, "cm"),
    legend.text = element_text(size = 8),  # reduce text
  legend.title = element_text(size = 9)  # reduce title
  )


virgaviridae_viruses <- gottcha_viruses_w_hosts %>%
  filter(Family == "Virgaviridae")

process_top_species <- function(df, tax_cols_start, sample_cols_start) {
  sample_cols <- sample_cols_start:ncol(df)

  # Determine top species by total abundance
  top_species <- df %>%
    group_by(SpeciesName) %>%
    summarise(across(all_of(names(df)[sample_cols]), sum), .groups = "drop") %>%
    mutate(total_abundance = rowSums(across(-SpeciesName))) %>%
    arrange(desc(total_abundance)) %>%
    slice_head(n = 7) %>%
    pull(SpeciesName)

  df_top <- df %>%
    mutate(SpeciesName = ifelse(SpeciesName %in% top_species, SpeciesName, "Other"))

  df_top$SpeciesName <- factor(df_top$SpeciesName, levels = c(setdiff(top_species, "Other"), "Other"))

  # Aggregate by SpeciesName
  species_abundances <- df_top %>%
    group_by(SpeciesName) %>%
    summarise(across(all_of(names(df)[sample_cols]), sum), .groups = "drop")

  long_df <- species_abundances %>%
    pivot_longer(cols = -SpeciesName, names_to = "SampleDate", values_to = "Abundance")

  relative_df <- long_df %>%
    group_by(SampleDate) %>%
    mutate(RelAbundance = Abundance / sum(Abundance)) %>%
    ungroup()

  return(relative_df)
}


relative_df_virgaviridae <- process_top_species(virgaviridae_viruses, 2, 10) %>%
  filter(SampleDate != "Sum") 


#make new x axis label with only month names
relative_df_virgaviridae$month_label <- format(as.Date(relative_df_virgaviridae$SampleDate), "%b %Y")



# Get unique time labels (for spacing)
time_levels2 <- unique(relative_df_virgaviridae$SampleDate)

# Get one label per month for spacing
monthly_ticks2 <- relative_df_virgaviridae |>
  dplyr::group_by(month_label) |>
  dplyr::summarise(x_tick = first(SampleDate)) |>
  dplyr::pull(x_tick)

# Get corresponding month names
monthly_labels2 <- relative_df_virgaviridae |>
  dplyr::group_by(month_label) |>
  dplyr::summarise(x_tick = first(SampleDate)) |>
  dplyr::pull(month_label)






virgabundance <- ggplot(relative_df_virgaviridae, aes(x = SampleDate, y = RelAbundance, fill = SpeciesName)) +
  geom_bar(stat = "identity", position = "stack") +
scale_fill_viridis_d(option = "plasma", direction = -1, begin = 0.1, end = 0.85,
                     labels = function(x) stringr::str_wrap(x, width = 20)) +
  scale_x_discrete(
  expand = c(0, 0),
  breaks = monthly_ticks2,
  labels = monthly_labels2
) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  labs(
    #title = "Top 5 Species in Virgaviridae"
    x = "Sample Date",
    y = "Relative Abundance (%)",
    fill = "Virgaviridae\nSpecies"
  ) +
  theme(
  text = element_text(size = 9),
  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8),
  axis.text.y = element_text(size= 9),
  legend.position = "top",
  legend.direction = "horizontal",
  legend.box = "horizontal",
  legend.key.width = unit(0.5, "cm"),
  legend.key.height = unit(0.5, "cm"),          # ↓ shrink height of keys
  legend.text = element_text(size = 5.5),         # ↓ shrink label text
  legend.title = element_text(size = 7),        # ↓ shrink title
  legend.margin = margin(t = 1, r = 2, b = -5, l = 2, unit = "pt")  # ↓ shrink box space
)


relative_df_euk_no_virga <- process_top_families(eukaryote_viruses_no_virga, 2, 10) %>%
  filter(SampleDate != "Sum")

# Create month labels and tick positions from relative_df_euk_no_virga
relative_df_euk_no_virga$month_label <- format(as.Date(relative_df_euk_no_virga$SampleDate), "%b %Y")

monthly_ticks_composite <- relative_df_euk_no_virga |>
  dplyr::group_by(month_label) |>
  dplyr::summarise(x_tick = first(SampleDate)) |>
  dplyr::pull(x_tick)

monthly_labels_composite <- relative_df_euk_no_virga |>
  dplyr::group_by(month_label) |>
  dplyr::summarise(x_tick = first(SampleDate)) |>
  dplyr::pull(month_label)


eukabundance_no_virga <- ggplot(relative_df_euk_no_virga, aes(x = SampleDate, y = RelAbundance, fill = Family)) +
  geom_bar(stat = "identity", position = "stack") +
scale_fill_viridis_d(option = "plasma", direction = -1, begin = 0.1, end = 0.85) + 
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  scale_x_discrete(
    expand = c(0, 0),
    breaks = monthly_ticks_composite,
    labels = monthly_labels_composite
  ) +
  labs(
    x = "Sample Date",
    y = "Relative Abundance (%)",
    fill = "Eukaryotic\nViral Family\n(Virgaviridae removed)"
  ) +
  theme(
    text = element_text(size = 10),
    #axis.text.x = element_text("angle = 90, vjust = 0.5, hjust = 1, size = 10"),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.width = unit(.5, "cm"),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8),
    axis.text.y = element_text(size = 9)
  )


# Prokaryote plot with x-axis text and title removed
prokabundance <- ggplot(relative_df_prokaryote, aes(x = SampleDate, y = RelAbundance, fill = Family)) +
  geom_bar(stat = "identity", position = "stack") +
scale_fill_viridis_d(option = "viridis", direction = -1, begin = 0.1, end = 0.85) +
  scale_x_discrete(
  expand = c(0, 0),
  breaks = monthly_ticks_composite,
  labels = monthly_labels_composite
)+
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  labs(
    #title = "Top 5 Viral Families (Prokaryote Hosts)"
    y = "Relative Abundance (%)",  # keep y-axis label here only
    x = NULL,
    fill = "Prokaryotic\nViral Family"
  ) +
  theme(text = element_text(size = 11),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.width = unit(.5, "cm"),
    legend.text = element_text(size = 8),  # reduce text
  legend.title = element_text(size = 9)  # reduce title
  )


composite_plot <- plot_grid(hostdomain_plot, eukabundance, eukabundance_no_virga,virgabundance,
                            ncol = 1,
                            align = "v",
                            axis = "lr",
                            rel_heights = c(.6, .7, .7, .85),
                            labels = c("A", "B", "C", "D"),
                            label_size = 13,
                            label_fontface = "bold",
                            label_y = c(1, 0.95, 0.95, 0.95))

#composite_plot <- hostdomain_plot / prokabundance / eukabundance / eukabundance_no_virga +
# plot_layout(heights = c(1, 1, 1, 1))

#composite_plot <- hostdomain_plot / prokabundance / eukabundance / virgabundance +
  #plot_layout(heights = c(1, 1, 1, 1))



# Composite figure
ggsave("./ManuscriptFigures/composite_top_10_viral_families_stackedbars.png",
       plot = composite_plot, width = 7, height = 9.5, dpi = 300)

ggsave("./ManuscriptFigures/composite_top_10_viral_families_stackedbars.tiff",
       plot = composite_plot, width = 7, height = 9.5, dpi = 600, compression = "lzw")

# Prokaryote-only panel
ggsave("./ManuscriptFigures/Prokabundance.png",
       plot = prokabundance, width = 7, height = 3, dpi = 300)

ggsave("./ManuscriptFigures/Prokabundance.tiff",
       plot = prokabundance, width = 7, height = 3, dpi = 600, compression = "lzw")



```

Alpha diversity with gottcha
```{r}

library(dplyr)
library(tidyr)
library(vegan)
library(boot)

# 1) Compute per‐sample Shannon H for each Domain
get_div <- function(df, name) {
  df %>%
    group_by(SpeciesName) %>%
    summarise(across(starts_with("20"), sum), .groups = "drop") %>%
    pivot_longer(-SpeciesName, names_to = "SampleDate", values_to = "count") %>%
    group_by(SampleDate) %>%
    summarise(H = diversity(count, index = "shannon"), .groups = "drop") %>%
    mutate(Domain = name)
}

div_prok <- get_div(prokaryote_viruses, "Prokaryote")
div_euka <- get_div(eukaryote_viruses, "Eukaryote")

# 2) Pivot to wide so each row is one date with both H’s
div_wide <- bind_rows(div_prok, div_euka) %>%
  pivot_wider(names_from = Domain, values_from = H)

# 3) Test normality of the within‐sample differences
diffs <- div_wide$Prokaryote - div_wide$Eukaryote
shapiro.test(diffs)

# 4) Paired t‐test (fixed: pass vectors explicitly)
paired_t <- t.test(
  x      = div_wide$Prokaryote,
  y      = div_wide$Eukaryote,
  paired = TRUE
)
print(paired_t)

# 5) Paired Wilcoxon signed‐rank test
wilcox_t <- wilcox.test(
  x      = div_wide$Prokaryote,
  y      = div_wide$Eukaryote,
  paired = TRUE
)
print(wilcox_t)

# 6) Bootstrap the mean difference (10 000 reps)
boot_mean_diff <- function(dat, i) {
  mean(dat$Prokaryote[i] - dat$Eukaryote[i])
}
set.seed(42)
b <- boot(data = div_wide, statistic = boot_mean_diff, R = 10000)
boot.ci(b, type = c("perc", "bca"))








# Combine and order SampleDate
div_all <- bind_rows(div_prok, div_euka) %>%
  filter(!is.na(H)) %>%
  mutate(
    SampleDate = factor(SampleDate, levels = sort(unique(SampleDate))),
    month_label = format(as.Date(as.character(SampleDate)), "%b %Y")
  )

# Create ticks and labels for month spacing
monthly_ticks_div <- div_all %>%
  group_by(month_label) %>%
  summarise(x_tick = first(SampleDate)) %>%
  pull(x_tick)

monthly_labels_div <- div_all %>%
  group_by(month_label) %>%
  summarise(x_tick = first(SampleDate)) %>%
  pull(month_label)

# Plot Shannon diversity by domain
diversity_plot <- ggplot(div_all, aes(x = SampleDate, y = H, color = Domain, group = Domain)) +
  geom_line(linewidth = 0.6) +
  geom_point(size = 1.5) +
  scale_x_discrete(
    expand = c(0, 0),
    breaks = monthly_ticks_div,
    labels = monthly_labels_div
  ) +
scale_fill_manual(values = c(Prokaryote = "#0072B2",  
                             Eukaryote = "#D55E00"))   +
  labs(
    x = "Sample Date",
    y = "H'",
    color = "Viral Host Domain"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.width = unit(.5, "cm"),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9),
    panel.grid.minor = element_blank()
  )

# Diversity plot by host domain
ggsave("./ManuscriptFigures/diversity_plot_by_domain.png",
       plot  = diversity_plot,
       width = 7,
       height = 2.5,
       dpi   = 300)

ggsave("./ManuscriptFigures/diversity_plot_by_domain.tiff",
       plot  = diversity_plot,
       width = 7,
       height = 2.5,
       dpi   = 600,
       compression = "lzw")


# 1) Compute per-sample Shannon H for each Domain
get_div <- function(df, name) {
  df %>%
    group_by(SpeciesName) %>%
    summarise(across(starts_with("20"), sum), .groups = "drop") %>%
    pivot_longer(-SpeciesName, names_to = "SampleDate", values_to = "count") %>%
    group_by(SampleDate) %>%
    summarise(H = diversity(count, index = "shannon"), .groups = "drop") %>%
    mutate(Domain = name)
}

div_prok <- get_div(prokaryote_viruses, "Prokaryote")
div_euka <- get_div(eukaryote_viruses, "Eukaryote")

# 🔹 NEW: Print mean ± SD for each domain
mean_prok <- mean(div_prok$H, na.rm = TRUE)
sd_prok   <- sd(div_prok$H, na.rm = TRUE)
mean_euka <- mean(div_euka$H, na.rm = TRUE)
sd_euka   <- sd(div_euka$H, na.rm = TRUE)

cat("Prokaryote viruses: mean H' =", round(mean_prok, 2), 
    "±", round(sd_prok, 2), "\n")
cat("Eukaryote viruses: mean H' =", round(mean_euka, 2), 
    "±", round(sd_euka, 2), "\n")




```



```{r}

# --- Alpha diversity with Virgaviridae removed from Eukaryotes ---

# Reuse the same helper
get_div <- function(df, name) {
  df %>%
    group_by(SpeciesName) %>%
    summarise(across(starts_with("20"), sum), .groups = "drop") %>%
    pivot_longer(-SpeciesName, names_to = "SampleDate", values_to = "count") %>%
    group_by(SampleDate) %>%
    summarise(H = diversity(count, index = "shannon"), .groups = "drop") %>%
    mutate(Domain = name)
}

# Diversity for Prokaryotes and Eukaryotes (Virgaviridae removed)
div_prok <- get_div(prokaryote_viruses, "Prokaryote")
div_euka_no_virga <- get_div(eukaryote_viruses_no_virga, "Eukaryote_noVirga")

# Wide format for paired tests
div_wide_no_virga <- bind_rows(div_prok, div_euka_no_virga) %>%
  pivot_wider(names_from = Domain, values_from = H)

# Normality of paired differences
diffs_no_virga <- div_wide_no_virga$Prokaryote - div_wide_no_virga$Eukaryote_noVirga
shapiro.test(diffs_no_virga)

# Paired t-test
t_no_virga <- t.test(
  x      = div_wide_no_virga$Prokaryote,
  y      = div_wide_no_virga$Eukaryote_noVirga,
  paired = TRUE
)
print(t_no_virga)

# Wilcoxon signed-rank test
wilcox_no_virga <- wilcox.test(
  x      = div_wide_no_virga$Prokaryote,
  y      = div_wide_no_virga$Eukaryote_noVirga,
  paired = TRUE
)
print(wilcox_no_virga)

# Bootstrap CI for the mean difference
boot_mean_diff_no_virga <- function(dat, i) {
  mean(dat$Prokaryote[i] - dat$Eukaryote_noVirga[i])
}
set.seed(42)
b_no_virga <- boot(data = div_wide_no_virga, statistic = boot_mean_diff_no_virga, R = 10000)
boot.ci(b_no_virga, type = c("perc", "bca"))

# --- Summarize mean ± SD for reporting ---
mean_prok <- mean(div_prok$H, na.rm = TRUE)
sd_prok   <- sd(div_prok$H, na.rm = TRUE)
mean_euka_no_virga <- mean(div_euka_no_virga$H, na.rm = TRUE)
sd_euka_no_virga   <- sd(div_euka_no_virga$H, na.rm = TRUE)

cat("Prokaryote viruses: mean H' =", round(mean_prok, 2), "±", round(sd_prok, 2), "\n")
cat("Eukaryote viruses (Virgaviridae removed): mean H' =", 
    round(mean_euka_no_virga, 2), "±", round(sd_euka_no_virga, 2), "\n")


```
Format Depth data for dpcr and clinical comparison
```{r}
DepthPerSample <- Fig1a_long %>%
  select(SampleID, TotalReads) %>%
  distinct() %>%
  mutate(RowID = row_number())

```


SARS RMP vs. dPCR
```{r}

###SARS RPM vs dPCR 

# Load libraries
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)



# 1) Load and format 2024 dPCR
dpcr <- read_excel("Columbia 2024 covid data.xlsx") %>%
  select(`Collection Week`, `Mean Copies/ L`) %>%
  rename(
    Collection_Week   = `Collection Week`,
    Mean_Copies_L     = `Mean Copies/ L`
  ) %>%
  filter(!is.na(Mean_Copies_L)) %>%
  mutate(
    Collection_Week        = format(as.Date(Collection_Week), "%y-%m-%d"),
    RowID                  = row_number()
  )

# Load 2025 dPCR data
dpcr2025 <- read_excel("Columbia COVID 2025 data 9.3.25.xlsx") %>%
  select(`Collection Week`, `Mean Copies/ L`) %>%
  rename(
    Collection_Week   = `Collection Week`,
    Mean_Copies_L     = `Mean Copies/ L`
  ) %>%
  filter(!is.na(Mean_Copies_L)) %>%
  mutate(
    Collection_Week        = format(as.Date(Collection_Week), "%y-%m-%d"),
    RowID                  = row_number()+53
  )

dpcr <- rbind(dpcr, dpcr2025)


# 2) Load flow data & compute flow-normalized copies
flow_mgd <- read_excel("Columbia meta data 9.3.25.xlsx")$`Average influent flow over sampling period (MGD):`
dpcr <- dpcr %>%
  mutate(Flow_normalized_copies = Mean_Copies_L * flow_mgd)


# 3) Load NOT-deduplicated metagenomics and depth data & merge
not_dedup <- read_csv("Not_dedup_summary.csv") %>%
  mutate(RowID = row_number())
not_dedup_2025 <- read_csv("not_dedup_summary_2025.csv") |>
  mutate(RowID = row_number()+53)

not_dedup <- rbind(not_dedup, not_dedup_2025)

WithDepth <- inner_join(dpcr, DepthPerSample, by = "RowID" )
not_dedup_merged <- inner_join(WithDepth, not_dedup, by = "RowID") %>%
  mutate(
    SARS_norm = (`SARS-CoV-2_NC_045512.2` / `TotalReads`)*1000000,
    SampleDate = Collection_Week
  )

# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_merged$Flow_normalized_copies,
  not_dedup_merged$SARS_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_merged <- not_dedup_merged %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)


# 6) Scale metagenomic trace for dual‐axis
max_dpcr  <- max(not_dedup_merged$Flow_normalized_copies, na.rm = TRUE)
max_norm  <- max(not_dedup_merged$SARS_norm, na.rm = TRUE)
sf        <- max_dpcr / max_norm
not_dedup_merged <- not_dedup_merged %>%
  mutate(Scaled_SARS_norm = SARS_norm * sf)

# Plot: dPCR vs normalized SARS (not dedup), no title, thicker lines, all fonts 11
p <- ggplot(not_dedup_merged, aes(x = SampleDate)) +
  geom_line(aes(y = Flow_normalized_copies, color = "dPCR"),    size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_norm,    color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "Total Viral Load\n(copies L⁻¹ x Flow Rate)",
    labels   = scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "SARS-CoV-2 RPM\n(Scaled to Total Viral Load)")
  ) +
  scale_x_discrete(name = "Sample Date",breaks = ticks, labels = labels, expand = c(0, 0)) +
  scale_color_manual(
    name   = NULL,
    values = c(dPCR = "#1F77B4", Metagenomics = "#FF7F0E")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "none",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

# Display
print(p)

RPM_dPCR <- p

```

SARS/ToBRV vs dPCR
```{r}

###SARS/ToBRFV vs dPCR 

not_dedup_merged <- not_dedup_merged %>%
  mutate(
    SARS_TBRV_norm = `SARS-CoV-2_NC_045512.2` / `ToBRFV_KT383474.1`,
    SampleDate = Collection_Week
  )

# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_merged$Flow_normalized_copies,
  not_dedup_merged$SARS_TBRV_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_merged <- not_dedup_merged %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)

# 6) Scale metagenomic trace for dual‐axis
max_dpcr  <- max(not_dedup_merged$Flow_normalized_copies, na.rm = TRUE)
max_norm  <- max(not_dedup_merged$SARS_TBRV_norm, na.rm = TRUE)
sf        <- max_dpcr / max_norm
not_dedup_merged <- not_dedup_merged %>%
  mutate(Scaled_SARS_TBRV_norm = SARS_TBRV_norm * sf)

# Plot: dPCR vs normalized SARS (not dedup), no title, thicker lines, all fonts 11
p <- ggplot(not_dedup_merged, aes(x = SampleDate)) +
  geom_line(aes(y = Flow_normalized_copies, color = "dPCR"),    size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_TBRV_norm,    color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "Total Viral Load\n(copies L⁻¹ x Flow Rate)",
    labels   = scales::scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "ToBRFV Normalized\nSARS-CoV-2 counts\n(Scaled to Total Viral Load)")
  ) +
  scale_x_discrete(name = "Sample Date",breaks = ticks, labels = labels, expand = c(0, 0)) +
  scale_color_manual(
    name   = NULL,
    values = c(dPCR = "#1F77B4", Metagenomics = "#9467BD")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "none",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

# Display
print(p)

ToBRVnormalized_dPCR <- p
```

SARS/Tobamoviruses vs. dPCR
```{r}


##SARS/Tobamoviruses vs dPCR 



# 3) Load NOT-deduplicated metagenomics & merge
not_dedup_tobamo <- read_csv("SARS_and_Tobamoviruses_2024.csv") %>%
  mutate(RowID = row_number())
not_dedup_tobamo_2025 <- read_csv("SARS_and_Tobamoviruses_2025.csv") |>
  mutate(RowID = row_number()+53) 
not_dedup_tobamo <- rbind(not_dedup_tobamo, not_dedup_tobamo_2025)
not_dedup_tobamo_merged <- inner_join(dpcr, not_dedup_tobamo, by = "RowID") %>%
  mutate(
    SARS_Tobamo_norm = `NC_045512.2` / `other_combined`,
    SampleDate = Collection_Week
  )


# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_tobamo_merged$Flow_normalized_copies,
  not_dedup_tobamo_merged$SARS_Tobamo_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_tobamo_merged <- not_dedup_tobamo_merged %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_tobamo_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_tobamo_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)

# 6) Scale metagenomic trace for dual‐axis
max_dpcr  <- max(not_dedup_tobamo_merged$Flow_normalized_copies, na.rm = TRUE)
max_norm  <- max(not_dedup_tobamo_merged$SARS_Tobamo_norm, na.rm = TRUE)
sf        <- max_dpcr / max_norm
not_dedup_tobamo_merged <- not_dedup_tobamo_merged %>%
  mutate(Scaled_SARS_Tobamo_norm = SARS_Tobamo_norm * sf)

# Plot: dPCR vs normalized SARS (not dedup), no title, thicker lines, all fonts 11
p <- ggplot(not_dedup_tobamo_merged, aes(x = SampleDate)) +
  geom_line(aes(y = Flow_normalized_copies, color = "dPCR"),    size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_Tobamo_norm,    color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "Total Viral Load\n(copies L⁻¹ x Flow Rate)",
    labels   = scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "SARS-CoV-2 Normalized\nto ToBRFV")
  ) +
  scale_x_discrete(name = "Sample Date",breaks = ticks, labels = labels, expand = c(0, 0)) +
  scale_color_manual(
    name   = NULL,
    values = c(dPCR = "#59688B", Metagenomics = "#EB7D62")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "top",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

# Display
print(p)




```

SARS/Virgaviridae vs dPCR
```{r}

#SARS VIRGA normalized and dPCR

# 3) Load NOT-deduplicated metagenomics & merge
not_dedup_virga <- read_csv("SARS_and_Virga_summary.csv") %>%
  mutate(RowID = row_number())
not_dedup_virga_2025 <- read_csv("SARS_and_Virgaviridae_2025.csv") |>
  mutate(RowID = row_number()+53) 
not_dedup_virga <- rbind(not_dedup_virga, not_dedup_virga_2025)
not_dedup_virga_merged <- inner_join(dpcr, not_dedup_virga, by = "RowID") %>%
  mutate(
    SARS_Virga_norm = `SARS-CoV-2_NC_045512.2` / `other_combined`,
    SampleDate = Collection_Week
  )


# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_virga_merged$Flow_normalized_copies,
  not_dedup_virga_merged$SARS_Virga_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_virga_merged <- not_dedup_virga_merged %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_virga_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_virga_merged %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)


# 6) Scale metagenomic trace for dual‐axis
max_dpcr  <- max(not_dedup_virga_merged$Flow_normalized_copies, na.rm = TRUE)
max_norm  <- max(not_dedup_virga_merged$SARS_Virga_norm, na.rm = TRUE)
sf        <- max_dpcr / max_norm
not_dedup_virga_merged <- not_dedup_virga_merged %>%
  mutate(Scaled_SARS_Virga_norm = SARS_Virga_norm * sf)

# Plot: dPCR vs normalized SARS (not dedup), no title, thicker lines, all fonts 11
p <- ggplot(not_dedup_virga_merged, aes(x = SampleDate)) +
  geom_line(aes(y = Flow_normalized_copies, color = "dPCR"),    size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_Virga_norm,    color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "Total Viral Load\n(copies L⁻¹ x Flow Rate)",
    labels   = scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "SARS-CoV-2 Normalized\nto ToBRFV")
  ) +
  scale_x_discrete(name = "Sample Date",breaks = ticks, labels = labels, expand = c(0, 0)) +
  scale_color_manual(
    name   = NULL,
    values = c(dPCR = "#59688B", Metagenomics = "#EB7D62")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "top",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

# Display
print(p)




```

SARS RPM vs clinical
```{r}

##SARS RPM vs clinical 

# Load libraries
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)



#1) Load case data
cases <- read.csv("SARS_cases.csv")



not_dedup_merged_cases <- inner_join(cases, not_dedup_merged, by = "RowID")


# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_merged_cases$Cases,
  not_dedup_merged_cases$SARS_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_merged_cases <- not_dedup_merged_cases %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_merged_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_merged_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)

# 6) Scale metagenomic trace for dual axis
max_cases <- max(not_dedup_merged_cases$Cases, na.rm = TRUE)  # <- use 'Cases' consistently
max_norm  <- max(not_dedup_merged_cases$SARS_norm, na.rm = TRUE)
sf        <- if (is.finite(max_cases / max_norm)) max_cases / max_norm else 1

not_dedup_merged_cases <- not_dedup_merged_cases %>%
  mutate(Scaled_SARS_norm = SARS_norm * sf)

# Plot: Cases vs normalized SARS (not dedup)
p <- ggplot(not_dedup_merged_cases, aes(x = SampleDate)) +
  geom_line(aes(y = Cases, color = "Cases"), size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_norm, color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "SARS-CoV-2 cases\nin Columbia, MO",
    labels   = scales::scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "SARS-CoV-2 RPM\n(Scaled to Clinical Cases)")
  ) +
  scale_x_discrete(
    name   = "Sample Date",
    breaks = ticks,
    labels = labels,
    expand = c(0, 0)
  ) +
  scale_color_manual(
    name   = NULL,
    values = c(Cases = "#2CA02C", Metagenomics = "#EB7D62")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "none",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

print(p)


RPM_clinical <- p

```

SARS/ToBRFV vs clinical
```{r}

##SARS/ToBRFV vs clinical 

# Load libraries
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)




# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_merged_cases$Cases,
  not_dedup_merged_cases$SARS_TBRV_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_merged_cases <- not_dedup_merged_cases %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_merged_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_merged_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)

# 6) Scale metagenomic trace for dual axis
max_cases <- max(not_dedup_merged_cases$Cases, na.rm = TRUE)  # <- use 'Cases' consistently
max_norm  <- max(not_dedup_merged_cases$SARS_TBRV_norm, na.rm = TRUE)
sf        <- if (is.finite(max_cases / max_norm)) max_cases / max_norm else 1

not_dedup_merged_cases <- not_dedup_merged_cases %>%
  mutate(Scaled_SARS_TBRV_norm = SARS_TBRV_norm * sf)

# Plot: Cases vs normalized SARS (not dedup)
p <- ggplot(not_dedup_merged_cases, aes(x = SampleDate)) +
  geom_line(aes(y = Cases, color = "Cases"), size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_TBRV_norm, color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "SARS-CoV-2 cases\nin Columbia, MO",
    labels   = scales::label_comma(),
    sec.axis = sec_axis(~ . / sf, name = "ToBRFV Normalized\nSARS-CoV-2 counts\n(Scaled to Clinical Cases)")
  ) +
  scale_x_discrete(
    name   = "Sample Date",
    breaks = ticks,
    labels = labels,
    expand = c(0, 0)
  ) +
  scale_color_manual(
    name   = NULL,
    values = c(Cases = "#2CA02C", Metagenomics = "#9467BD")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "none",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

print(p)

ToBRVnormalized_Clinical <- p

```

SARS/Tobamoviruses vs clinical
```{r}

##SARS/Tobamoviruses vs clinical 

# Load libraries
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)



not_dedup_merged_tobamo_cases <- inner_join(cases, not_dedup_tobamo_merged, by = "RowID")

# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_merged_tobamo_cases$Cases,
  not_dedup_merged_tobamo_cases$SARS_Tobamo_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_merged_tobamo_cases <- not_dedup_merged_tobamo_cases %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_merged_tobamo_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_merged_tobamo_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)

# 6) Scale metagenomic trace for dual axis
max_cases <- max(not_dedup_merged_tobamo_cases$Cases, na.rm = TRUE)  # <- use 'Cases' consistently
max_norm  <- max(not_dedup_merged_tobamo_cases$SARS_Tobamo_norm, na.rm = TRUE)
sf        <- if (is.finite(max_cases / max_norm)) max_cases / max_norm else 1

not_dedup_merged_tobamo_cases <- not_dedup_merged_tobamo_cases %>%
  mutate(Scaled_SARS_Tobamo_norm = SARS_Tobamo_norm * sf)


# Plot: Cases vs normalized SARS (not dedup)
p <- ggplot(not_dedup_merged_tobamo_cases, aes(x = SampleDate)) +
  geom_line(aes(y = Cases, color = "Cases"), size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_Tobamo_norm, color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "SARS-CoV-2 cases\nin Columbia, MO",
    labels   = scales::scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "SARS-CoV-2 (normalized to ToBRFV)")
  ) +
  scale_x_discrete(
    name   = "Sample Date",
    breaks = ticks,
    labels = labels,
    expand = c(0, 0)
  ) +
  scale_color_manual(
    name   = NULL,
    values = c(Cases = "#59688B", Metagenomics = "#EB7D62")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "top",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

print(p)





```

SARS/Virgaviridae vs clinical
```{r}
##SARS/Virgaviridae vs clinical 

# Load libraries
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)



not_dedup_merged_virga_cases <- inner_join(cases, not_dedup_virga_merged, by = "RowID")

# 4) Compute Pearson r, 95% CI, and p-value
res <- cor.test(
  not_dedup_merged_virga_cases$Cases,
  not_dedup_merged_virga_cases$SARS_Virga_norm,
  method = "pearson"
)
r  <- unname(res$estimate)
ci <- res$conf.int
p  <- res$p.value
cat(sprintf(
  "Pearson’s r = %.3f (95%% CI %.3f–%.3f), p = %.2g\n",
  r, ci[1], ci[2], p
))

# 5) Prepare monthly x-axis labels (first date each YEAR-MONTH)
not_dedup_merged_virga_cases <- not_dedup_merged_virga_cases %>%
  mutate(
    SampleDate_date = as.Date(paste0("20", SampleDate)),  # fix "2" -> "20"
    month_key   = format(SampleDate_date, "%Y-%m"),       # year-month key
    month_label = format(SampleDate_date, "%b %Y"),      # e.g., "Jan 2024"
    SampleDate  = factor(SampleDate, levels = unique(SampleDate))
  )

ticks <- not_dedup_merged_virga_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(SampleDate)

labels <- not_dedup_merged_virga_cases %>%
  group_by(month_key) %>%
  slice_head(n = 1) %>%
  pull(month_label)

# 6) Scale metagenomic trace for dual axis
max_cases <- max(not_dedup_merged_virga_cases$Cases, na.rm = TRUE)  # <- use 'Cases' consistently
max_norm  <- max(not_dedup_merged_virga_cases$SARS_Virga_norm, na.rm = TRUE)
sf        <- if (is.finite(max_cases / max_norm)) max_cases / max_norm else 1

not_dedup_merged_virga_cases <- not_dedup_merged_virga_cases %>%
  mutate(Scaled_SARS_Virga_norm = SARS_Virga_norm * sf)


# Plot: Cases vs normalized SARS (not dedup)
p <- ggplot(not_dedup_merged_virga_cases, aes(x = SampleDate)) +
  geom_line(aes(y = Cases, color = "Cases"), size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_Virga_norm, color = "Metagenomics"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "SARS-CoV-2 cases\nin Columbia, MO",
    labels   = scales::scientific_format(digits = 2),
    sec.axis = sec_axis(~ . / sf, name = "SARS-CoV-2 (normalized to ToBRFV)")
  ) +
  scale_x_discrete(
    name   = "Sample Date",
    breaks = ticks,
    labels = labels,
    expand = c(0, 0)
  ) +
  scale_color_manual(
    name   = NULL,
    values = c(Cases = "#59688B", Metagenomics = "#EB7D62")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "top",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

print(p)





```

Save ToBRV normalized dpcr and clinical comparisons
```{r}
library(cowplot)

# Remove x-axis elements from the top panel (as you already had)
ToBRVnormalized_Clinical_noxaxis <- ToBRVnormalized_Clinical +
  theme(
    axis.text.x  = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y.right = element_blank(),    # 🔧 NEW: remove scaled y tick labels (right side)
    axis.ticks.y.right = element_blank()    # 🔧 NEW: remove tick marks (right side)
  )

# Do the same for the bottom (dPCR) panel
ToBRVnormalized_dPCR_noyright <- ToBRVnormalized_dPCR +
  theme(
    axis.text.y.right = element_blank(),    # 🔧 Remove scaled y tick labels
    axis.ticks.y.right = element_blank()    # 🔧 Remove tick marks
  )

# Stack vertically (ncol = 1) with shared x-axis
Clincial_and_dPCR <- plot_grid(
  ToBRVnormalized_Clinical_noxaxis,
  ToBRVnormalized_dPCR_noyright,
  ncol = 1,
  align = "v",
  axis = "lr",
  rel_heights = c(.75, 1),
  labels = c("A", "B"),
  label_size = 13,
  label_fontface = "bold"
)

# Preview
Clincial_and_dPCR

# Save high-res version
ggsave(
  filename = "./Figures6/clinical_and_dPCR_vertical.png",
  plot = Clincial_and_dPCR,
  width = 5, height = 6, dpi = 300
)

```

```{r}
# Compute scaling factor between SARS RPM and ToBRFV-normalized
max_rpm   <- max(not_dedup_merged$SARS_norm, na.rm = TRUE)
max_tbrv  <- max(not_dedup_merged$SARS_TBRV_norm, na.rm = TRUE)
sf        <- if (is.finite(max_rpm / max_tbrv)) max_rpm / max_tbrv else 1

# Add scaled ToBRFV-normalized values
not_dedup_merged <- not_dedup_merged %>%
  mutate(SARS_TBRV_scaled = SARS_TBRV_norm * sf)

# Plot
p_rpm_vs_tobrfv <- ggplot(not_dedup_merged, aes(x = SampleDate)) +
  geom_line(aes(y = SARS_norm, color = "SARS RPM"), size = 1.2, group = 1) +
  geom_line(aes(y = SARS_TBRV_scaled, color = "ToBRFV Normalized"), size = 1.2, group = 1) +
  scale_y_continuous(
    name     = "SARS-CoV-2 reads per million",
    labels   = scales::label_comma(),
    sec.axis = sec_axis(~ . / sf, name = "ToBRFV Normalized\nSARS-CoV-2 reads")
  ) +
  scale_x_discrete(
    name   = "Sample Date",
    breaks = ticks,
    labels = labels,
    expand = c(0, 0)
  ) +
  scale_color_manual(
    name   = NULL,
    values = c(`SARS RPM` = "#59688B", `ToBRFV Normalized` = "#EB7D62")
  ) +
  theme(
    text            = element_text(size = 11),
    axis.title.y    = element_text(size = 11),
    axis.text.x     = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    axis.text.y     = element_text(size = 11),
    axis.ticks.x    = element_line(),
    legend.position = "top",
    legend.text     = element_text(size = 11),
    legend.key.width= unit(0.5, "cm")
  )

# Preview
print(p_rpm_vs_tobrfv)

# Save object
RPM_vs_TOBRFV <- p_rpm_vs_tobrfv


```


```{r}

# Apply theme modifications to each plot
ToBRVnormalized_Clinical_noyright <- ToBRVnormalized_Clinical +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.49),
           hjust = 1.1, vjust = 1.5, size = 3)

RPM_clinical_noyright <- RPM_clinical +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())+
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.13),
           hjust = 1.1, vjust = 1.5, size = 3)

ToBRVnormalized_dPCR_noyright <- ToBRVnormalized_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())+
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.47),
           hjust = 1.1, vjust = 1.5, size = 3)

# RPC_cases (special: remove x axis text & ticks too)
RPM_dPCR_noxaxis <- RPM_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())+
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.41),
           hjust = 1.1, vjust = 1.5, size = 3)

# Build composite plot
composite_normalizing_plot <- plot_grid(
  ToBRVnormalized_Clinical_noyright,
  RPM_clinical_noyright,
  ToBRVnormalized_dPCR_noyright,
  RPM_dPCR_noxaxis,
  ncol = 2,
  align = "v",
  axis = "lr",
  rel_heights = c(0.8, 1, 0.8, 1),
  labels = c("A", "B", "C", "D"),
  label_size = 13,
  label_fontface = "bold"
)

# Preview
composite_normalizing_plot

# Save image
ggsave(
  filename = "./Figures6/Normalizing_composite_plot.png",
  plot = composite_normalizing_plot,
  width = 8, height = 6, dpi = 300
)


```
Make legend for dPCR and clinical figure
```{r}

library(ggplot2)
library(dplyr)

# =========================
# Create dummy data ONLY to generate legend
# =========================
legend_data <- data.frame(
  series = c(
    "dPCR",
    "RPM",
    "PMMoV normalized reads",
    "ToBRFV normalized reads"
  ),
  x = 1:4,
  y = 1
) %>%
  mutate(
    series = factor(
      series,
      levels = c(
        "dPCR",
        "RPM",
        "PMMoV normalized reads",
        "ToBRFV normalized reads"
      )
    )
  )

# =========================
# Define custom colors
# =========================
line_colors <- c(
  "dPCR" = "#1F77B4",
  "RPM" = "#FF7F0E",
  "PMMoV normalized reads" = "brown3",
  "ToBRFV normalized reads" = "#9467BD"
)

# =========================
# Build legend-only plot
# =========================
legend_plot <- ggplot(legend_data, aes(x = x, y = y, color = series)) +
  geom_line(linewidth = 1.2) +
  scale_color_manual(values = line_colors) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    legend.key.width = unit(1.2, "cm")
  )

legend_plot

# =========================
# Save legend (PNG + TIFF)
# =========================
ggsave("./ManuscriptFigures/dPCRLegend.png",
       plot  = legend_plot,
       width = 7,
       height = 2.5,
       dpi   = 300)

ggsave("./ManuscriptFigures/dPCRLegend.tiff",
       plot  = legend_plot,
       width = 7,
       height = 2.5,
       dpi   = 600,
       compression = "lzw")

```

```{r}

# Apply theme modifications to each plot

ToBRVnormalized_dPCR_noyright <- ToBRVnormalized_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())+
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.47),
           hjust = 1.1, vjust = 1.5, size = 3)

# RPC_cases (special: remove x axis text & ticks too)
RPM_dPCR_noxaxis <- RPM_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())+
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.41),
           hjust = 1.1, vjust = 1.5, size = 3)

# Build composite plot
composite_normalizing_plot_noclinic <- plot_grid(
  ToBRVnormalized_dPCR_noyright,
  RPM_dPCR_noxaxis,
  ncol = 2,
  align = "v",
  axis = "lr",
  rel_heights = c(0.8, 1),
  labels = c("A", "B"),
  label_size = 13,
  label_fontface = "bold"
)

# Preview
composite_normalizing_plot_noclinic

# Save image
#ggsave(
#  filename = "./Figures6/Normalizing_composite_plot_noclinic.png",
#  plot = composite_normalizing_plot_noclinic,
#  width = 8, height = 3.5, dpi = 300
#)






```


```{r}
library(dplyr)
library(readr)
library(stringr)

# ---- Read your combined PMMoV summary (2024+2025) ----
# Must have columns like: sample,<SARS header>,PMMoV
pmmov_sum <- read_csv("summary_SARS_PMMoV.csv")

# The SARS column name is whatever your first reference header was in the CSV;
# it's the 2nd column in that file.
sars_col <- names(pmmov_sum)[2]

pmmov_sum <- pmmov_sum %>%
  rename(
    sample = 1,
    SARS_reads = all_of(sars_col),
    PMMoV_reads = PMMoV
  ) %>%
  mutate(
    RowID = row_number()
  ) %>%
  select(RowID, PMMoV_reads)

# ---- Join onto your existing analysis table (BY ORDER) ----
not_dedup_merged <- not_dedup_merged %>%
  left_join(pmmov_sum, by = "RowID") %>%
  mutate(
    # PMMoV normalization ANALOGOUS to your ToBRFV normalization:
    SARS_PMMOV_norm = `SARS-CoV-2_NC_045512.2` / PMMoV_reads
  )

```

```{r}
### SARS/PMMoV vs dPCR  ---------------------------------------------

# Use only finite paired observations for correlation
ok <- is.finite(not_dedup_merged$Flow_normalized_copies) &
      is.finite(not_dedup_merged$SARS_PMMOV_norm)

res <- cor.test(
  not_dedup_merged$Flow_normalized_copies[ok],
  not_dedup_merged$SARS_PMMOV_norm[ok],
  method = "pearson"
)

r  <- unname(res$estimate)
r2 <- r^2


# Dual-axis scaling (match style used elsewhere)
max_dpcr <- max(not_dedup_merged$Flow_normalized_copies[ok], na.rm = TRUE)
max_norm <- max(not_dedup_merged$SARS_PMMOV_norm[ok], na.rm = TRUE)
sf <- max_dpcr / max_norm

not_dedup_merged <- not_dedup_merged %>%
  mutate(Scaled_SARS_PMMOV_norm = SARS_PMMOV_norm * sf)

p <- ggplot(not_dedup_merged, aes(x = SampleDate)) +
  geom_line(aes(y = Flow_normalized_copies, color = "dPCR"), size = 1.2, group = 1) +
  geom_line(aes(y = Scaled_SARS_PMMOV_norm, color = "PMMoV"), size = 1.2, group = 1) +
  scale_color_manual(values = c("dPCR" = "#1F77B4", "PMMoV" = "brown3")) +
  scale_y_continuous(
    name = "Total Viral Load\n(copies L⁻¹ x Flow Rate)",
    sec.axis = sec_axis(~ . / sf, name = "PMMoV Normalized\nSARS-CoV-2 counts")
  ) +
  scale_x_discrete(name = "Sample Date", breaks = ticks, labels = labels, expand = c(0, 0)) +
  labs(x = "Sample Date") +
  theme(
    text = element_text(size = 11),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 11),
    legend.position = "none"
  )


PMMoVnormalized_dPCR <- p

```


```{r}

# Apply theme modifications (mirroring what you already do)
RPM_dPCR_noyright <- RPM_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())

PMMoVnormalized_dPCR_noyright <- PMMoVnormalized_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())+
          annotate("text", x = Inf, y = Inf, 
           label = expression(R^2 == 0.24),
           hjust = 1.1, vjust = 1.5, size = 3)

        

#ToBRVnormalized_dPCR_noyright <- ToBRVnormalized_dPCR +
#  theme(axis.text.y.right = element_blank(),
#        axis.ticks.y.right = element_blank())

# New order: A = RPM, B = PMMoV, C = ToBRFV
composite_normalizing_plot_noclinic <- plot_grid(
  RPM_dPCR_noxaxis,
  PMMoVnormalized_dPCR_noyright,
  ToBRVnormalized_dPCR_noyright,
  ncol = 3,
  align = "v",
  axis = "lr",
  labels = c("A", "B", "C"),
  label_size = 13,
  label_fontface = "bold"
)

# Normalizing composite plot (no clinic data)
#ggsave(
#  filename = "./ManuscriptFigures/Normalizing_composite_plot_noclinic.p#ng",
#  plot     = composite_normalizing_plot_noclinic,
#  width    = 12,
#  height   = 3.5,
#  dpi      = 300
#)

#ggsave(
#  filename = "./ManuscriptFigures/Normalizing_composite_plot_noclinic.#tiff",
#  plot     = composite_normalizing_plot_noclinic,
#  width    = 12,
#  height   = 3.5,
#  dpi      = 600,
#  compression = "lzw"
#)




```

```{r}

library(ggplot2)
library(dplyr)
library(cowplot)
library(grid)

# =========================
# 1) Build legend plot (your same approach)
# =========================
legend_data <- data.frame(
  series = c("dPCR", "RPM", "PMMoV normalized reads", "ToBRFV normalized reads"),
  x = 1:4,
  y = 1
) %>%
  mutate(series = factor(series, levels = c(
    "dPCR", "RPM", "PMMoV normalized reads", "ToBRFV normalized reads"
  )))

line_colors <- c(
  "dPCR" = "#1F77B4",
  "RPM" = "#FF7F0E",
  "PMMoV normalized reads" = "brown3",
  "ToBRFV normalized reads" = "#9467BD"
)

legend_plot <- ggplot(legend_data, aes(x = x, y = y, color = series)) +
  geom_line(linewidth = 1.2) +
  scale_color_manual(values = line_colors) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),     # change if you want a title
    legend.text = element_text(size = 10),
    legend.key.width = unit(1.2, "cm")
  )

# Sanity check: you should see the legend when you print this
print(legend_plot)

# ---- Robust legend extraction (guide-box) ----
g <- ggplotGrob(legend_plot)
guide_idx <- which(sapply(g$grobs, function(x) x$name) == "guide-box")
if (length(guide_idx) == 0) stop("No legend found in legend_plot (no 'guide-box').")
legend_g <- g$grobs[[guide_idx[1]]]

# Optional: print extracted legend alone to confirm
print(ggdraw() + draw_grob(legend_g))

# =========================
# 2) Build your composite (your code)
# =========================
RPM_dPCR_noyright <- RPM_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank())

PMMoVnormalized_dPCR_noyright <- PMMoVnormalized_dPCR +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  annotate("text", x = Inf, y = Inf,
           label = expression(R^2 == 0.24),
           hjust = 1.1, vjust = 1.5, size = 3)

composite_normalizing_plot_noclinic <- plot_grid(
  RPM_dPCR_noxaxis,
  PMMoVnormalized_dPCR_noyright,
  ToBRVnormalized_dPCR_noyright,
  ncol = 3,
  align = "v",
  axis = "lr",
  labels = c("A", "B", "C"),
  label_size = 13,
  label_fontface = "bold"
)

# =========================
# 3) Make bigger canvas + paste composite near top + legend below
# =========================
final_plot <- ggdraw() +
  # paste composite near the top (leave room below for legend)
  draw_plot(composite_normalizing_plot_noclinic,
            x = 0.00, y = 0.22, width = 1.00, height = 0.78) +
  # paste legend below (centered-ish; tweak x/width if you want right-justified)
  draw_grob(legend_g,
            x = 0.18, y = 0.1, width = 0.64, height = 0.18)

print(final_plot)

# =========================
# 4) Save as single image (PNG + TIFF)
# =========================
ggsave(
  filename = "./ManuscriptFigures/Normalizing_composite_plot_noclinic_withlegend.png",
  plot     = final_plot,
  width    = 12,
  height   = 4.2,    # taller than 3.5 to fit legend under panels
  dpi      = 300
)

ggsave(
  filename = "./ManuscriptFigures/Normalizing_composite_plot_noclinic_withlegend.tiff",
  plot     = final_plot,
  width    = 12,
  height   = 4.2,
  dpi      = 600,
  device   = "tiff",
  compression = "lzw"
)

```

```{r}
library(readr)
library(dplyr)
library(stringr)
library(purrr)
library(tibble)

# --- 1. Taxonomic lineage setup ---
lineage_cols <- c(
  "Domain", "SubDomain",
  "Phylum", "SubPhylum",
  "Class", "SubClass",
  "Order", "SubOrder",
  "Family", "SubFamily",
  "Genus", "SubGenus",
  "Species", "SubSpecies"
)

rank_map <- list(
  "D" = c("Domain", "SubDomain"),
  "P" = c("Phylum", "SubPhylum"),
  "C" = c("Class", "SubClass"),
  "O" = c("Order", "SubOrder"),
  "F" = c("Family", "SubFamily"),
  "G" = c("Genus", "SubGenus"),
  "S" = c("Species", "SubSpecies")
)

# --- 2. Function to process a single kraken report (TXT) ---
process_kraken_file <- function(filepath) {

  df <- read_tsv(
    filepath,
    col_names = FALSE,
    show_col_types = FALSE,
    progress = FALSE
  ) |> as_tibble()

  if (ncol(df) < 6) {
    stop("File has <6 columns; not a Kraken report: ", basename(filepath))
  }
  if (ncol(df) > 6) {
    df <- df[, 1:6]
  }

  colnames(df) <- c("percent_reads", "reads_clade", "reads_direct", "rank_code", "taxid_or_indent", "taxon_name")
  df$taxon_name <- str_replace(df$taxon_name, "^\\s+", "")

  lineage <- setNames(rep(NA_character_, length(lineage_cols)), lineage_cols)
  output_rows <- vector("list", nrow(df))

  for (i in seq_len(nrow(df))) {
    row <- df[i, ]
    rk_code <- as.character(row$rank_code)
    taxon   <- as.character(row$taxon_name)

    match <- str_match(rk_code, "^([A-Z])([0-9]*)$")
    if (!is.na(match[1, 1])) {
      base   <- match[1, 2]
      suffix <- match[1, 3]

      if (base %in% names(rank_map)) {
        colname <- ifelse(suffix == "", rank_map[[base]][1], rank_map[[base]][2])
        lineage[[colname]] <- taxon

        downstream <- which(lineage_cols == colname) + 1
        if (downstream <= length(lineage_cols)) {
          lineage[downstream:length(lineage_cols)] <- NA_character_
        }
      }
    }

    lineage_row <- as.list(lineage)
    output_rows[[i]] <- c(as.list(row), lineage_row, Assignment = taxon)
  }

  bind_rows(output_rows)
}

# --- 3. Process all TXT reports in k2reports (ABSOLUTE PATH) ---
k2_dir <- "C:/Users/Rushf/OneDrive/Desktop/Work/manuscript/R/NVDvisualizations/k2reports"
stopifnot(dir.exists(k2_dir))

k2_files <- list.files(
  path = k2_dir,
  pattern = "\\.k2\\.txt$",
  full.names = TRUE
)
stopifnot(length(k2_files) > 0)

# Mergeable SampleID from filename:
make_sample_id <- function(x) {
  basename(x) |>
    str_replace("\\.(PlusPFP|PFP)\\.k2\\.txt$", "") |>
    str_replace("\\.k2\\.txt$", "")
}

sample_ids <- map_chr(k2_files, make_sample_id)

sample_dfs <- purrr::set_names(
  purrr::map(k2_files, process_kraken_file),
  sample_ids
)
 

# --- 5. Add SampleID + TotalReads to each df in sample_dfs ---

add_sample_metadata <- function(df, sample_id) {

  # Make sure reads_clade is numeric (readr usually does, but be explicit)
  df <- df %>% mutate(reads_clade = as.numeric(reads_clade))

  # Identify unclassified and root rows
  is_unclassified <- str_to_lower(df$taxon_name) == "unclassified"
  is_root <- str_to_lower(df$taxon_name) == "root"

  if (!any(is_unclassified)) warning("No 'unclassified' row found for ", sample_id)
  if (!any(is_root)) warning("No 'root' row found for ", sample_id)

  total_reads <- sum(df$reads_clade[is_unclassified], df$reads_clade[is_root], na.rm = TRUE)

  df %>%
    mutate(
      SampleID = sample_id,
      TotalReads = total_reads
    )
}

sample_dfs <- imap(sample_dfs, add_sample_metadata)

# quick check
sample_dfs[[1]] %>% select(SampleID, TotalReads) %>% distinct()

kraken_all <- bind_rows(sample_dfs)

kraken_all <- kraken_all %>%
  mutate(
    reads_direct_rpm = (reads_direct / TotalReads) * 1e6
  )

kraken_viruses <- kraken_all %>%
  filter(Domain == "Viruses")


library(dplyr)
library(stringr)

# Flag species-resolved rows
kraken_viruses2 <- kraken_viruses %>%
  mutate(
    Species_clean   = na_if(str_trim(Species), ""),
    is_species_rank = str_detect(rank_code, "^S"),
    is_resolved     = !is.na(Species_clean) & is_species_rank
  )

# 1) Species-resolved: keep lineage + sum RPM per species per sample
resolved_species <- kraken_viruses2 %>%
  filter(is_resolved) %>%
  group_by(
    SampleID,
    Domain, SubDomain,
    Phylum, SubPhylum,
    Class, SubClass,
    Order, SubOrder,
    Family, SubFamily,
    Genus, SubGenus,
    Species
  ) %>%
  summarise(
    reads_direct_rpm = sum(reads_direct_rpm, na.rm = TRUE),
    TotalReads = first(TotalReads),
    rank_code = "S",
    .groups = "drop"
  )

# 2) Not resolved: one row per sample (lineage not meaningful, so set to NA)
unresolved_bucket <- kraken_viruses2 %>%
  filter(!is_resolved) %>%
  group_by(SampleID) %>%
  summarise(
    Domain = "Viruses",
    SubDomain = NA_character_,
    Phylum = NA_character_, SubPhylum = NA_character_,
    Class  = NA_character_, SubClass  = NA_character_,
    Order  = NA_character_, SubOrder  = NA_character_,
    Family = NA_character_, SubFamily = NA_character_,
    Genus  = NA_character_, SubGenus  = NA_character_,
    Species = "Not resolved to species",
    reads_direct_rpm = sum(reads_direct_rpm, na.rm = TRUE),
    TotalReads = first(TotalReads),
    rank_code = "UNRESOLVED",
    .groups = "drop"
  )

# Combine
kraken_species_summed <- bind_rows(resolved_species, unresolved_bucket)

















```

```{r}
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(scales)
library(cowplot)
library(viridis)   # for scale_fill_viridis_d()

# =========================
# 1) Keep only species-resolved rows (exclude unresolved bucket)
# =========================
kraken_resolved <- kraken_species_summed %>%
  filter(rank_code == "S", !is.na(Species), Species != "Not resolved to species")

# =========================
# 2) Parse SampleID -> SampleDate ID for x-axis
#    KEEP as character / factor (do NOT convert SampleDate to Date)
#    Target format: yyyymmdd (matches your general convention)
# =========================
kraken_resolved <- kraken_resolved %>%
  mutate(
    SampleDate = str_extract(SampleID, "\\d{8}"),
    SampleDate = if_else(is.na(SampleDate), SampleID, SampleDate)
  )

# Order dates chronologically (string ordering works for yyyymmdd)
date_levels <- kraken_resolved %>%
  distinct(SampleDate) %>%
  arrange(SampleDate) %>%
  pull(SampleDate)

kraken_resolved <- kraken_resolved %>%
  mutate(SampleDate = factor(SampleDate, levels = date_levels))

# Month labels + tick positions (one tick per month)
month_id <- substr(date_levels, 1, 6)  # yyyymm
first_in_month <- tapply(date_levels, month_id, function(x) x[1]) |> unname()

# Create month labels (safe to use as.Date() ONLY for label text; axis variable stays factor)
month_labels <- format(
  as.Date(paste0(substr(first_in_month, 1, 4), "-", substr(first_in_month, 5, 6), "-01")),
  "%b %Y"
)

# We'll use these breaks/labels in panels that show x-axis text
monthly_ticks  <- first_in_month
monthly_labels <- month_labels

# =========================
# 3) HostDomain annotation by Phylum
# =========================
hostdomains <- read.csv("Phylum_Host_Annotation.csv") %>%
  select(Phylum, HostDomain)

kraken_resolved <- kraken_resolved %>%
  left_join(hostdomains, by = "Phylum") %>%
  mutate(HostDomain = if_else(is.na(HostDomain), "Unknown", HostDomain))

# =========================
# Helpers: top-N + "Other" + relative abundance per sample
# =========================
top_n_with_other <- function(df, group_col, value_col, n = 7, exclude_value = NULL) {
  if (!is.null(exclude_value)) {
    df <- df %>% filter(.data[[group_col]] != exclude_value)
  }

  top_groups <- df %>%
    filter(!is.na(.data[[group_col]])) %>%
    group_by(.data[[group_col]]) %>%
    summarise(total = sum(.data[[value_col]], na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(total)) %>%
    slice_head(n = n) %>%
    pull(.data[[group_col]])

  out <- df %>%
    mutate(
      GroupPlot = if_else(.data[[group_col]] %in% top_groups,
                          as.character(.data[[group_col]]),
                          "Other")
    ) %>%
    group_by(SampleDate, GroupPlot) %>%
    summarise(Value = sum(.data[[value_col]], na.rm = TRUE), .groups = "drop") %>%
    group_by(SampleDate) %>%
    mutate(RelAbundance = Value / sum(Value, na.rm = TRUE)) %>%
    ungroup()

  # Force legend order: top groups then Other
  out$GroupPlot <- factor(out$GroupPlot, levels = c(as.character(top_groups), "Other"))

  out
}

# =========================
# Shared theme elements to match your GOTCHA composite styling
# =========================
theme_panel_no_x <- theme(
  text = element_text(size = 11),
  axis.text.x = element_blank(),
  axis.title.x = element_blank(),
  axis.ticks.x = element_blank(),
  legend.position = "top",
  legend.direction = "horizontal",
  legend.box = "horizontal",
  legend.key.width = unit(0.5, "cm"),
  legend.text = element_text(size = 8),
  legend.title = element_text(size = 9)
)

theme_panel_with_x <- theme(
  text = element_text(size = 10),
  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8),
  axis.text.y = element_text(size = 9),
  legend.position = "top",
  legend.direction = "horizontal",
  legend.box = "horizontal",
  legend.key.width = unit(0.5, "cm"),
  legend.key.height = unit(0.5, "cm"),
  legend.text = element_text(size = 6),
  legend.title = element_text(size = 8),
  legend.margin = margin(t = 1, r = 2, b = -5, l = 2, unit = "pt")
)

# Truncated viridis ranges to avoid the very bright yellow end
vir_begin <- 0.10
vir_end   <- 0.85

# =========================
# A) Relative abundance by host domain
# =========================
hostdomain_df <- kraken_resolved %>%
  filter(HostDomain %in% c("Prokaryote", "Eukaryote", "Unknown")) %>%
  group_by(SampleDate, HostDomain) %>%
  summarise(Value = sum(reads_direct_rpm, na.rm = TRUE), .groups = "drop") %>%
  group_by(SampleDate) %>%
  mutate(RelAbundance = Value / sum(Value, na.rm = TRUE)) %>%
  ungroup()

plot_A <- ggplot(hostdomain_df, aes(x = SampleDate, y = RelAbundance, fill = HostDomain)) +
  geom_col(width = 0.9) +
  scale_fill_manual(values = c(Prokaryote = "#0072B2",
                               Eukaryote  = "#D55E00",
                               Unknown    = "grey70")) +
  scale_y_continuous(labels = percent_format(), expand = c(0, 0)) +
  labs(x = NULL, y = "Relative Abundance (%)", fill = "Virus Host\nDomain") +
  theme_panel_no_x

# =========================
# B) Top 7 viral families + Other (all viruses)
# =========================

# Subset for eukaryote-infecting viruses (for panels B and C only)
kraken_euk <- kraken_resolved %>% 
  filter(HostDomain == "Eukaryote")



family_df_all <- top_n_with_other(
  df = kraken_euk,
  group_col = "Family",
  value_col = "reads_direct_rpm",
  n = 7
)

plot_B <- ggplot(family_df_all, aes(x = SampleDate, y = RelAbundance, fill = GroupPlot)) +
  geom_col(width = 0.9) +
  scale_fill_viridis_d(option = "plasma", direction = -1, begin = vir_begin, end = vir_end) +
  scale_y_continuous(labels = percent_format(), expand = c(0, 0)) +
  labs(x = NULL, y = "Relative Abundance (%)", fill = "Eukaryotic/\nViral Family") +
  theme_panel_no_x

# =========================
# C) Top 7 families + Other excluding Virgaviridae
# =========================
family_df_no_virga <- top_n_with_other(
  df = kraken_euk,
  group_col = "Family",
  value_col = "reads_direct_rpm",
  n = 7,
  exclude_value = "Virgaviridae"
)

plot_C <- ggplot(family_df_no_virga, aes(x = SampleDate, y = RelAbundance, fill = GroupPlot)) +
  geom_col(width = 0.9) +
  scale_fill_viridis_d(option = "plasma", direction = -1, begin = vir_begin, end = vir_end) +
  scale_y_continuous(labels = percent_format(), expand = c(0, 0)) +
  labs(x = NULL, y = "Relative Abundance (%)",
       fill = "Eukaryotic\nViral Family\n(Virgaviridae removed)") +
  theme_panel_no_x

# =========================
# D) Within Virgaviridae: Top 7 species + Other (WITH x-axis labels shown)
# =========================
virga_species_df <- kraken_resolved %>%
  filter(Family == "Virgaviridae") %>%
  top_n_with_other(group_col = "Species", value_col = "reads_direct_rpm", n = 7)

plot_D <- ggplot(virga_species_df, aes(x = SampleDate, y = RelAbundance, fill = GroupPlot)) +
  geom_col(width = 0.9) +
  scale_fill_viridis_d(option = "plasma", direction = -1, begin = vir_begin, end = vir_end,
                       labels = function(x) stringr::str_wrap(x, width = 20)) +
  scale_x_discrete(expand = c(0, 0), breaks = monthly_ticks, labels = monthly_labels, drop = FALSE) +
  scale_y_continuous(labels = percent_format(), expand = c(0, 0)) +
  labs(x = "Sample Date", y = "Relative Abundance (%)", fill = "Virgaviridae\nSpecies") +
  theme_panel_with_x

# =========================
# Composite plot (A–D) styled to match your earlier GOTCHA composite
# =========================
composite_plot_kraken <- plot_grid(
  plot_A, plot_B, plot_C, plot_D,
  ncol = 1,
  align = "v",
  axis = "lr",
  rel_heights = c(0.6, 0.7, 0.7, 0.85),
  labels = c("A", "B", "C", "D"),
  label_size = 13,
  label_fontface = "bold",
  label_y = c(1, 0.95, 0.95, 0.95)
)

# =========================
# Prokabundance (top families infecting prokaryotes) styled like your prokabundance panel
# =========================
kraken_prok <- kraken_resolved %>% filter(HostDomain == "Prokaryote")

prok_family_df <- top_n_with_other(
  df = kraken_prok,
  group_col = "Family",
  value_col = "reads_direct_rpm",
  n = 7
)

prokabundance_kraken <- ggplot(prok_family_df, aes(x = SampleDate, y = RelAbundance, fill = GroupPlot)) +
  geom_col(width = 0.9) +
  scale_fill_viridis_d(option = "viridis", direction = -1, begin = vir_begin, end = vir_end) +
  scale_x_discrete(expand = c(0, 0), breaks = monthly_ticks, labels = monthly_labels, drop = FALSE) +
  scale_y_continuous(labels = percent_format(), expand = c(0, 0)) +
  labs(x = NULL, y = "Relative Abundance (%)", fill = "Prokaryotic\nViral Family") +
  theme(
    text = element_text(size = 11),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 10),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key.width = unit(0.5, "cm"),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9)
  )

# =========================
# Save to ManuscriptFigures (PNG + TIFF)
# =========================
dir.create("./ManuscriptFigures", showWarnings = FALSE)

ggsave("./ManuscriptFigures/composite_top_families_KRAKEN.png",
       plot = composite_plot_kraken, width = 7, height = 10, dpi = 300)

ggsave("./ManuscriptFigures/composite_top_families_KRAKEN.tiff",
       plot = composite_plot_kraken, width = 7, height = 10, dpi = 600, compression = "lzw")

ggsave("./ManuscriptFigures/prokabundance_KRAKEN.png",
       plot = prokabundance_kraken, width = 7, height = 3, dpi = 300)

ggsave("./ManuscriptFigures/prokabundance_KRAKEN.tiff",
       plot = prokabundance_kraken, width = 7, height = 3, dpi = 600, compression = "lzw")


```

```{r}

# ---- Create a shareable, filtered input file for GitHub ----

filtered_etl_path <- "metagenomic_hits_top_hit_etl_example_31108_31648.tsv"

etl_raw %>%
  filter(
    `Sewershed Location` == "Columbia, MO",
    Experiment %in% c(31108, 31648)
  ) %>%
  write_tsv(filtered_etl_path)

message("Wrote filtered ETL file to: ", filtered_etl_path)


```
